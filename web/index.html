<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition System - Intelligent Face Recognition Platform</title>
    <meta name="description"
        content="Deep learning-based face recognition system supporting person registration, recognition, management and analytics">
    <meta name="keywords" content="face recognition,deep learning,person management,InsightFace">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üëÅÔ∏è</text></svg>">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom styles -->
    <link href="assets/css/main.css" rel="stylesheet">

    <!-- Personnel management enhanced styles -->
    <style>
        /* Face photo gallery styles */
        .face-thumbnail {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .face-thumbnail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .face-image-container {
            position: relative;
            height: 80px;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .face-image-container:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .face-image-container:active {
            transform: scale(0.98);
        }

        .face-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-placeholder {
            height: 80px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .face-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .face-thumbnail:hover .face-actions {
            opacity: 1;
        }

        .btn-action {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .face-info {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .face-thumbnail:hover .face-info {
            opacity: 1;
        }

        /* Upload area styles */
        .upload-area {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-area:hover {
            border-color: var(--bs-primary) !important;
            background-color: rgba(var(--bs-primary-rgb), 0.05);
        }

        /* Information card style enhancement */
        .info-card {
            background: rgba(var(--bs-primary-rgb), 0.05);
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid var(--bs-primary);
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--bs-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            font-weight: 500;
            color: var(--bs-dark);
        }

        /* Modal enhancement */
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%);
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
            .face-actions {
                opacity: 1;
                /* Always show action buttons on mobile devices */
            }

            .btn-action {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }
        }

        /* Camera styles */
        .webcam-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .webcam-container.active {
            border-color: var(--bs-success);
            background: rgba(var(--bs-success-rgb), 0.1);
        }

        #webcamVideo {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            display: none;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .face-overlay {
            position: absolute;
            border: 3px solid;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
        }

        .face-overlay.known {
            border-color: #28a745;
            color: #28a745;
        }

        .face-overlay.unknown {
            border-color: #ffc107;
            color: #ffc107;
        }

        .face-label {
            position: absolute;
            top: -30px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 600;
        }

        .face-confidence {
            position: absolute;
            bottom: -25px;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        .webcam-placeholder {
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--bs-secondary);
        }

        .webcam-status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            display: none;
        }

        .webcam-status.recording {
            background: rgba(220, 53, 69, 0.9);
            animation: pulse 2s infinite;
        }

        .webcam-status.active {
            background: rgba(25, 135, 84, 0.9);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .recognition-mode-tabs {
            background: rgba(var(--bs-primary-rgb), 0.05);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .recognition-mode-tabs .nav-link {
            border-radius: 8px;
            border: none;
            color: var(--bs-primary);
            font-weight: 500;
            padding: 8px 16px;
        }

        .recognition-mode-tabs .nav-link.active {
            background: var(--bs-primary);
            color: white;
        }

        .live-results {
            background: linear-gradient(135deg, rgba(var(--bs-success-rgb), 0.1) 0%, rgba(var(--bs-info-rgb), 0.1) 100%);
            border: 1px solid rgba(var(--bs-success-rgb), 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .detected-person {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .person-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bs-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .confidence-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--bs-warning), var(--bs-success));
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Registration mode selection styles */
        .registration-mode-card {
            transition: all 0.2s ease;
        }

        .registration-mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .registration-mode-card .btn-check:checked+.btn {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
        }

        .registration-mode-card .btn-check:checked+.btn.btn-outline-success {
            background-color: var(--bs-success);
            border-color: var(--bs-success);
        }

        /* Custom radio button styles */
        .custom-radio-btn {
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

        .custom-radio-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .custom-radio-btn.active {
            background-color: var(--bs-primary) !important;
            color: white !important;
            border-color: var(--bs-primary) !important;
        }

        .custom-radio-btn.active.btn-outline-success {
            background-color: var(--bs-success) !important;
            border-color: var(--bs-success) !important;
        }

        /* Video registration specific styles */
        .video-registration-container {
            position: relative;
        }

        #registrationVideo {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 10px;
            display: none;
        }

        .recording-progress {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
        }

        .face-detection-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 10;
        }

        .face-detection-indicator .alert {
            backdrop-filter: blur(4px);
        }

        /* Enhanced photo preview styles */
        #enrollmentImages .col-md-3 {
            margin-bottom: 15px;
        }

        .enrollment-photo-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
        }

        .enrollment-photo-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--bs-primary);
        }

        .enrollment-photo-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .enrollment-photo-card .photo-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .enrollment-photo-card:hover .photo-actions {
            opacity: 1;
        }

        .enrollment-photo-card .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: white;
            padding: 20px 10px 10px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .enrollment-photo-card:hover .photo-info {
            opacity: 1;
        }

        /* Frame preview styles */
        #capturedFrames {
            overflow-x: auto;
            /* Allow horizontal scrolling if needed */
        }

        #capturedFrames .col-2,
        #capturedFrames .col-md-2 {
            margin-bottom: 10px;
            flex: 0 0 auto;
            /* Prevent flex items from shrinking */
            min-width: 80px;
            /* Minimum width for each frame */
        }

        .captured-frame {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .captured-frame img {
            width: 100%;
            height: 60px;
            object-fit: cover;
        }

        .captured-frame .frame-number {
            position: absolute;
            top: 2px;
            left: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Upload zone enhancements */
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--bs-primary);
            background-color: rgba(var(--bs-primary-rgb), 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--bs-success);
            background-color: rgba(var(--bs-success-rgb), 0.1);
            transform: scale(1.02);
        }

        /* Accuracy tips */
        .accuracy-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .accuracy-indicator.low {
            background: rgba(var(--bs-warning-rgb), 0.1);
            color: var(--bs-warning);
            border: 1px solid rgba(var(--bs-warning-rgb), 0.3);
        }

        .accuracy-indicator.medium {
            background: rgba(var(--bs-info-rgb), 0.1);
            color: var(--bs-info);
            border: 1px solid rgba(var(--bs-info-rgb), 0.3);
        }

        .accuracy-indicator.high {
            background: rgba(var(--bs-success-rgb), 0.1);
            color: var(--bs-success);
            border: 1px solid rgba(var(--bs-success-rgb), 0.3);
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-camera-reels me-2"></i>
                Face Recognition System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="recognition-tab" data-bs-toggle="tab"
                            data-bs-target="#recognition" type="button" role="tab" aria-controls="recognition"
                            aria-selected="true">
                            <i class="bi bi-search me-1"></i>Face Recognition
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="enrollment-tab" data-bs-toggle="tab" data-bs-target="#enrollment"
                            type="button" role="tab" aria-controls="enrollment" aria-selected="false">
                            <i class="bi bi-person-plus me-1"></i>Person Registration
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="management-tab" data-bs-toggle="tab" data-bs-target="#management"
                            type="button" role="tab" aria-controls="management" aria-selected="false">
                            <i class="bi bi-people me-1"></i>Person Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics"
                            type="button" role="tab" aria-controls="analytics" aria-selected="false">
                            <i class="bi bi-bar-chart me-1"></i>Analytics
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main content area -->
    <main class="container my-4">
        <div class="tab-content" id="mainTabContent">
            <!-- Face recognition tab -->
            <div class="tab-pane fade show active" id="recognition" role="tabpanel" aria-labelledby="recognition-tab">
                <!-- Recognition mode selection -->
                <div class="recognition-mode-tabs">
                    <ul class="nav nav-pills nav-fill" id="recognitionModeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="live-mode-tab" data-bs-toggle="pill"
                                data-bs-target="#live-mode" type="button" role="tab" aria-controls="live-mode"
                                aria-selected="true">
                                <i class="bi bi-camera-video me-2"></i>
                                Live Recognition
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-mode-tab" data-bs-toggle="pill"
                                data-bs-target="#upload-mode" type="button" role="tab" aria-controls="upload-mode"
                                aria-selected="false">
                                <i class="bi bi-cloud-upload me-2"></i>
                                Upload Recognition
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="tab-content" id="recognitionModeContent">
                    <!-- Real-time recognition mode -->
                    <div class="tab-pane fade show active" id="live-mode" role="tabpanel"
                        aria-labelledby="live-mode-tab">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-camera-video-fill me-2"></i>
                                            Live Camera Recognition
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="webcam-container" id="webcamContainer">
                                            <video id="webcamVideo" autoplay muted></video>
                                            <div class="video-overlay" id="videoOverlay"></div>
                                            <div class="webcam-placeholder" id="webcamPlaceholder">
                                                <i class="bi bi-camera-video"
                                                    style="font-size: 3rem; margin-bottom: 15px;"></i>
                                                <h6>Start Camera for Live Recognition</h6>
                                                <p class="mb-0 text-center">Click the button below to enable the camera,
                                                    the system will automatically recognize faces</p>
                                                <small class="text-muted">Supports camera access on all modern
                                                    browsers</small>
                                            </div>
                                            <div class="webcam-status" id="webcamStatus">
                                                <i class="bi bi-record-circle me-1"></i>
                                                Recognizing...
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="recognitionRegion" class="form-label">Select Region *</label>
                                            <select class="form-select" id="recognitionRegion" required>
                                                <option value="">Select Region</option>
                                                <option value="ka">KA - Karnataka</option>
                                                <option value="ap">AP - Andhra Pradesh</option>
                                                <option value="tn">TN - Tamil Nadu</option>
                                            </select>
                                            <small class="text-muted">Recognition will only search in the selected
                                                region</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="cameraSelect" class="form-label">Select Camera Device</label>
                                            <select class="form-select" id="cameraSelect">
                                                <option value="">Detecting cameras...</option>
                                            </select>
                                            <small class="text-muted">If camera startup fails, try selecting a different
                                                device</small>
                                        </div>

                                        <div class="d-grid gap-2 mt-3">
                                            <button id="startWebcamBtn" class="btn btn-success btn-lg">
                                                <i class="bi bi-camera-video me-2"></i>
                                                Start Camera
                                            </button>
                                            <button id="stopWebcamBtn" class="btn btn-danger btn-lg"
                                                style="display: none;">
                                                <i class="bi bi-stop-circle me-2"></i>
                                                Stop Recognition
                                            </button>
                                            <button id="retryRecognitionBtn" class="btn btn-warning btn-lg"
                                                style="display: none;">
                                                <i class="bi bi-arrow-clockwise me-2"></i>
                                                Retry Recognition
                                            </button>
                                        </div>

                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Recognition Frequency</small>
                                                <span id="recognitionFrequency" class="badge bg-secondary">Every
                                                    2s</span>
                                            </div>
                                            <input type="range" class="form-range" id="recognitionInterval" min="1"
                                                max="5" value="1" step="1">
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>1s</span>
                                                <span>3s</span>
                                                <span>5s</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-person-check me-2"></i>
                                            Live Recognition Results
                                            <span id="liveResultsCount" class="badge bg-primary ms-2">0</span>
                                        </h5>
                                    </div>
                                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                        <div id="liveRecognitionResults">
                                            <div class="empty-state">
                                                <i class="bi bi-camera-video"></i>
                                                <h6>Waiting for Camera</h6>
                                                <p class="mb-0">Live recognition results will appear after starting the
                                                    camera</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recognition history -->
                                <div class="live-results mt-3" id="recognitionHistory" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            <i class="bi bi-clock-history me-1"></i>
                                            Recent Recognition
                                        </h6>
                                        <button class="btn btn-outline-secondary btn-sm"
                                            onclick="clearRecognitionHistory()">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    </div>
                                    <div id="historyList" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload recognition mode -->
                    <div class="tab-pane fade" id="upload-mode" role="tabpanel" aria-labelledby="upload-mode-tab">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-cloud-upload-fill me-2"></i>
                                            Upload Photo for Recognition
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="upload-zone" id="uploadZone">
                                            <div class="upload-content">
                                                <i class="bi bi-cloud-upload"></i>
                                                <h6>Click or Drag to Upload Photo</h6>
                                                <p class="mb-0">Supports JPEG, PNG, WebP, AVIF, BMP, TIFF formats</p>
                                                <small class="text-muted">Max file size: 10MB | Recommended resolution:
                                                    640x480 or higher</small>
                                            </div>
                                            <input type="file" id="imageFile" accept="image/*" style="display: none;">
                                        </div>

                                        <div id="imagePreview" class="mt-3" style="display: none;">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-primary fw-semibold">Image Preview</span>
                                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                                    onclick="clearImagePreview()">
                                                    <i class="bi bi-x me-1"></i>Reselect
                                                </button>
                                            </div>
                                            <img id="previewImg" class="img-fluid rounded shadow" alt="Preview Image"
                                                style="max-height: 300px;">
                                            <div id="imageInfo" class="mt-2 small text-muted"></div>
                                        </div>

                                        <div class="d-grid gap-2 mt-3">
                                            <button id="recognizeBtn" class="btn btn-primary btn-lg" disabled>
                                                <i class="bi bi-search me-2"></i>
                                                Start Recognition
                                            </button>
                                            <div class="d-flex gap-2">
                                                <button id="clearBtn" class="btn btn-outline-secondary flex-fill"
                                                    onclick="clearRecognition()" style="display: none;">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                                    Reset
                                                </button>
                                                <button id="downloadBtn" class="btn btn-outline-primary flex-fill"
                                                    onclick="downloadResult()" style="display: none;">
                                                    <i class="bi bi-download me-1"></i>
                                                    Download Result
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-clipboard-data me-2"></i>
                                            Recognition Results
                                        </h5>
                                    </div>
                                    <div class="card-body position-relative">
                                        <div id="recognitionResults">
                                            <div class="empty-state">
                                                <i class="bi bi-search"></i>
                                                <h6>Waiting for Recognition</h6>
                                                <p class="mb-0">Please upload a photo to start recognition</p>
                                            </div>
                                        </div>
                                        <div id="recognitionLoading" class="loading-overlay" style="display: none;">
                                            <div class="text-center">
                                                <div class="loading-spinner mb-3"></div>
                                                <div class="fw-semibold text-primary">Recognizing...</div>
                                                <div class="small text-muted">Please wait, analyzing facial features
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Person Registration Tab -->
            <div class="tab-pane fade" id="enrollment" role="tabpanel" aria-labelledby="enrollment-tab">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-person-plus me-2"></i>
                                    Register New Person
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="enrollmentForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="personName" class="form-label">
                                                Name *
                                            </label>
                                            <input type="text" class="form-control" id="personName"
                                                placeholder="Enter name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="personRegion" class="form-label">Region *</label>
                                            <select class="form-select" id="personRegion" required>
                                                <option value="">Select Region</option>
                                                <option value="ka">KA - Karnataka</option>
                                                <option value="ap">AP - Andhra Pradesh</option>
                                                <option value="tn">TN - Tamil Nadu</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="empId" class="form-label">Employee ID *</label>
                                            <input type="text" class="form-control" id="empId"
                                                placeholder="Enter Employee ID" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="empRank" class="form-label">Employee Rank *</label>
                                            <input type="text" class="form-control" id="empRank"
                                                placeholder="Enter Employee Rank" required>
                                        </div>
                                    </div>

                                    <!-- Registration Mode Selection -->
                                    <div class="mb-4">
                                        <label class="form-label">Registration Method *</label>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="registration-mode-card" id="photoModeCard">
                                                    <input type="radio" class="d-none" name="registrationMode"
                                                        id="photoMode" value="photo" checked>
                                                    <div class="btn btn-outline-primary w-100 p-3 custom-radio-btn active"
                                                        data-target="photoMode"
                                                        onclick="switchRegistrationMode('photo', this)">
                                                        <i class="bi bi-images fs-2 d-block mb-2"></i>
                                                        <strong>Photo Upload</strong>
                                                        <small class="d-block text-muted">Upload multiple photos for
                                                            training</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="registration-mode-card" id="videoModeCard">
                                                    <input type="radio" class="d-none" name="registrationMode"
                                                        id="videoMode" value="video">
                                                    <div class="btn btn-outline-success w-100 p-3 custom-radio-btn"
                                                        data-target="videoMode"
                                                        onclick="switchRegistrationMode('video', this)">
                                                        <i class="bi bi-camera-video fs-2 d-block mb-2"></i>
                                                        <strong>Video Registration</strong>
                                                        <small class="d-block text-muted">5-second video capture for
                                                            better accuracy</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Photo Upload Section -->
                                    <div id="photoUploadSection" class="mb-3">
                                        <label class="form-label">
                                            Photo Upload
                                            <span class="badge bg-primary ms-1">Recommended: 3-5 photos</span>
                                        </label>
                                        <div class="upload-zone" id="enrollmentUpload">
                                            <div class="upload-content">
                                                <i class="bi bi-images"></i>
                                                <h6>Click or Drag to Upload Multiple Photos</h6>
                                                <p class="mb-0">Supports JPEG, PNG, WebP formats</p>
                                                <small class="text-muted">
                                                    <strong>Tips for better accuracy:</strong><br>
                                                    ‚Ä¢ Upload 3-5 different photos<br>
                                                    ‚Ä¢ Include different angles (front, slight left/right)<br>
                                                    ‚Ä¢ Vary lighting conditions<br>
                                                    ‚Ä¢ Show different expressions
                                                </small>
                                            </div>
                                            <input type="file" id="enrollmentFile" accept="image/*" multiple
                                                style="display: none;">
                                        </div>

                                        <div id="enrollmentPreview" class="mt-3" style="display: none;">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="form-label mb-0">Photo Preview</label>
                                                <span id="photoCount" class="badge bg-info">0 photos selected</span>
                                            </div>
                                            <div id="enrollmentImages" class="row"></div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    <span id="accuracyTip">Add more photos for better recognition
                                                        accuracy</span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Video Registration Section -->
                                    <div id="videoRegistrationSection" class="mb-3" style="display: none;">
                                        <label class="form-label">
                                            Video Registration
                                            <span class="badge bg-success ms-1">High Accuracy</span>
                                        </label>

                                        <div class="video-registration-container">
                                            <div class="webcam-container mb-3 active" id="registrationWebcamContainer">
                                                <video id="registrationVideo" autoplay muted playsinline
                                                    style="display: block;"></video>
                                                <div class="webcam-placeholder" id="registrationPlaceholder"
                                                    style="display: none;">
                                                    <i class="bi bi-camera-video"
                                                        style="font-size: 3rem; margin-bottom: 15px;"></i>
                                                    <h6>Video Registration</h6>
                                                    <p class="mb-0 text-center">Camera is initializing...</p>
                                                    <small class="text-muted">Please wait a moment</small>
                                                </div>
                                                <div class="webcam-status active" id="registrationStatus"
                                                    style="display: block;">
                                                    <i class="bi bi-camera-video-fill me-1"></i>
                                                    <span>Camera Starting...</span>
                                                </div>

                                                <!-- Recording Progress -->
                                                <div class="recording-progress" id="recordingProgress"
                                                    style="display: none;">
                                                    <div class="progress mb-2">
                                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
                                                            id="recordingProgressBar" role="progressbar"
                                                            style="width: 0%"></div>
                                                    </div>
                                                    <div class="text-center text-white">
                                                        <strong id="recordingCountdown">5</strong> seconds remaining
                                                    </div>
                                                </div>

                                                <!-- Face Detection Indicator -->
                                                <div class="face-detection-indicator" id="faceDetectionIndicator"
                                                    style="display: block;">
                                                    <div class="alert alert-info mb-0">
                                                        <i class="bi bi-camera-video me-2"></i>
                                                        <strong>Camera Ready</strong>
                                                        <span id="detectionMessage">The 5-second video capture will
                                                            start automatically in a moment</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-grid gap-2">
                                                <button id="startVideoRegistrationBtn" class="btn btn-success btn-lg"
                                                    style="display: none;">
                                                    <i class="bi bi-camera-video me-2"></i>
                                                    Start Video Registration
                                                </button>
                                                <button id="stopVideoRegistrationBtn" class="btn btn-danger btn-lg"
                                                    style="display: none;">
                                                    <i class="bi bi-stop-circle me-2"></i>
                                                    Stop Recording
                                                </button>
                                                <button id="retakeVideoBtn" class="btn btn-outline-secondary"
                                                    style="display: none;">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                                    Retake Video
                                                </button>
                                            </div>

                                            <!-- Video Preview -->
                                            <div id="videoPreviewSection" class="mt-3" style="display: none;">
                                                <label class="form-label">Captured Frames Preview</label>
                                                <div id="capturedFrames" class="row"></div>
                                                <div class="mt-2">
                                                    <small class="text-success">
                                                        <i class="bi bi-check-circle me-1"></i>
                                                        <span id="frameCount">0</span> frames captured successfully
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="button" id="enrollBtn" class="btn btn-success btn-lg" disabled>
                                            <i class="bi bi-person-plus me-1"></i>
                                            Register Person
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="clearEnrollment()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>
                                            Reset All
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Registration Results
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="enrollmentResults">
                                    <div class="empty-state">
                                        <i class="bi bi-person-plus"></i>
                                        <h6>Waiting for Registration Info</h6>
                                        <p class="mb-0">Please upload photos and fill in information</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Attendance Section -->
                <div class="card mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>Attendance Records
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="attendanceDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="attendanceDate" value="">
                            </div>
                            <div class="col-md-4">
                                <label for="attendanceRegion" class="form-label">Region</label>
                                <select class="form-select" id="attendanceRegion">
                                    <option value="">All Regions</option>
                                    <option value="ka">KA - Karnataka</option>
                                    <option value="ap">AP - Andhra Pradesh</option>
                                    <option value="tn">TN - Tamil Nadu</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="loadAttendance()">
                                    <i class="bi bi-search me-2"></i>View Attendance
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="attendanceSummary" style="display: none;">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h3 class="text-primary mb-0" id="totalEmployees">0</h3>
                                        <small class="text-muted">Total Employees</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 class="mb-0" id="presentCount">0</h3>
                                        <small>Present</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3 class="mb-0" id="absentCount">0</h3>
                                        <small>Absent</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="attendanceTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Photo</th>
                                        <th>Name</th>
                                        <th>Emp ID</th>
                                        <th>Rank</th>
                                        <th>Status</th>
                                        <th>Marked At</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            Select date and region to view attendance
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Person Management Tab -->
            <div class="tab-pane fade" id="management" role="tabpanel" aria-labelledby="management-tab">
                <!-- Top Action Bar -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body py-3">
                                <div class="d-flex align-items-center">
                                    <h5 class="card-title mb-0 me-3">
                                        <i class="bi bi-people-fill me-2 text-primary"></i>
                                        Person Management
                                    </h5>
                                    <span class="badge bg-primary person-count">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body py-3">
                                <div class="d-flex gap-2">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-search"></i>
                                        </span>
                                        <input type="text" class="form-control" id="searchPerson"
                                            placeholder="Search people...">
                                    </div>
                                    <button class="btn btn-outline-primary" onclick="refreshPersonList()"
                                        title="Refresh">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showSortOptions()" title="Sort">
                                        <i class="bi bi-sort-down"></i>
                                    </button>
                                    <button class="btn btn-primary" onclick="showBulkOperations()" title="Bulk Actions">
                                        <i class="bi bi-list-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Operations Panel -->
                <div class="bulk-operations-panel" style="display: none;">
                    <div class="card border-warning mb-3">
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-check2-square me-2"></i>
                                    <strong>Bulk Actions</strong>
                                    <small id="selectedCount" class="ms-2">(0 selected)</small>
                                </div>
                                <button class="btn btn-sm btn-outline-dark" onclick="hideBulkOperations()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body py-2">
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="selectAllPersons()">
                                    <i class="bi bi-check-all me-1"></i>Select All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearAllSelections()">
                                    <i class="bi bi-square me-1"></i>Clear Selection
                                </button>
                                <div class="vr"></div>
                                <button class="btn btn-sm btn-outline-success" onclick="exportSelectedPersons()"
                                    id="bulkExportBtn" disabled>
                                    <i class="bi bi-download me-1"></i>Export Selected
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedPersons()"
                                    id="bulkDeleteBtn" disabled>
                                    <i class="bi bi-trash me-1"></i>Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Person List -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-grid-3x3-gap me-2"></i>
                                    Person List
                                </h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="viewMode" id="cardView" checked>
                                    <label class="btn btn-outline-secondary" for="cardView" title="Card View">
                                        <i class="bi bi-grid"></i>
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="listView">
                                    <label class="btn btn-outline-secondary" for="listView" title="List View">
                                        <i class="bi bi-list"></i>
                                    </label>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div id="personsList">
                                    <div class="d-flex justify-content-center p-5">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="text-muted">Loading person data...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar Information Panel -->
                    <div class="col-lg-4">
                        <!-- Quick Statistics -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-bar-chart me-2"></i>
                                    Quick Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h4 class="text-primary mb-1" id="totalPersonsCount">0</h4>
                                            <small class="text-muted">Total People</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-success mb-1" id="totalFacesCount">0</h4>
                                        <small class="text-muted">Total Photos</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Operations -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-clock-history me-2"></i>
                                    Recent Operations
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="recentOperations">
                                    <small class="text-muted">No operation records</small>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Operations Panel -->
                        <div class="card" id="bulkOperationsPanel" style="display: none;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-list-check me-2"></i>
                                    Bulk Operations
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="selectAllPersons()">
                                        <i class="bi bi-check-all me-1"></i>Select All
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                        <i class="bi bi-x-square me-1"></i>Clear Selection
                                    </button>
                                    <hr>
                                    <button class="btn btn-outline-danger btn-sm" onclick="bulkDeletePersons()" disabled
                                        id="bulkDeleteBtn">
                                        <i class="bi bi-trash me-1"></i>Bulk Delete
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="exportSelectedPersons()"
                                        disabled id="bulkExportBtn">
                                        <i class="bi bi-download me-1"></i>Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                <!-- Top Overview Cards - Simplified Layout -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="analytics-card">
                            <div class="analytics-icon bg-primary">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div class="analytics-info">
                                <h3 id="statTotalPersons">0</h3>
                                <p>Total People</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="analytics-card">
                            <div class="analytics-icon bg-success">
                                <i class="bi bi-camera-fill"></i>
                            </div>
                            <div class="analytics-info">
                                <h3 id="statTotalEncodings">0</h3>
                                <p>Total Photos</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="analytics-card">
                            <div class="analytics-icon bg-warning">
                                <i class="bi bi-bullseye"></i>
                            </div>
                            <div class="analytics-info">
                                <h3 id="statThreshold">0.35</h3>
                                <p>Recognition Threshold</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="analytics-card">
                            <div class="analytics-icon bg-info">
                                <i class="bi bi-cpu"></i>
                            </div>
                            <div class="analytics-info">
                                <h3 class="text-success">Normal</h3>
                                <p>System Status</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="row">
                    <!-- Left Side: Real-time Statistics Panel -->
                    <div class="col-lg-8">
                        <div class="analytics-panel">
                            <div class="analytics-header">
                                <h5><i class="bi bi-bar-chart-line me-2"></i>System Statistics</h5>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshAllData()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="analytics-content">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="stat-item">
                                            <strong>Total Registered People</strong>
                                            <span id="detailTotalPersons">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-item">
                                            <strong>Total Face Photos</strong>
                                            <span id="detailTotalEncodings">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-item">
                                            <strong>Average Photos per Person</strong>
                                            <span id="avgPhotosPerPerson">0.0 photos</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stat-item">
                                            <strong>Current Threshold</strong>
                                            <span id="currentThreshold">0.35</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="quick-actions mt-4">
                                    <button class="btn btn-outline-success btn-sm" onclick="exportStatistics()">
                                        <i class="bi bi-download me-1"></i>Export Statistics
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="downloadSystemReport()">
                                        <i class="bi bi-file-text me-1"></i>System Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Side: Configuration Panel -->
                    <div class="col-lg-4">
                        <div class="analytics-panel">
                            <div class="analytics-header">
                                <h5><i class="bi bi-gear-fill me-2"></i>System Configuration</h5>
                            </div>
                            <div class="analytics-content">
                                <form id="configForm">
                                    <div class="config-item">
                                        <label for="recognitionThreshold" class="form-label">Face Recognition
                                            Threshold</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" id="recognitionThresholdRange"
                                                min="0.1" max="0.9" step="0.01" value="0.2">
                                            <input type="number" class="form-control" id="recognitionThreshold"
                                                min="0.1" max="0.9" step="0.01" value="0.2">
                                        </div>
                                        <small class="text-muted">Current: <span
                                                id="recognitionThresholdDisplay">0.2</span></small>
                                        <div class="form-text text-muted mt-1">Similarity threshold for matching known
                                            faces. Higher values require stricter matching, only very similar faces will
                                            be considered the same person</div>
                                    </div>

                                    <div class="config-item">
                                        <label for="detectionThreshold" class="form-label">Face Detection
                                            Threshold</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" id="detectionThresholdRange"
                                                min="0.1" max="0.9" step="0.01" value="0.5">
                                            <input type="number" class="form-control" id="detectionThreshold" min="0.1"
                                                max="0.9" step="0.01" value="0.5">
                                        </div>
                                        <small class="text-muted">Current: <span
                                                id="detectionThresholdDisplay">0.5</span></small>
                                        <div class="form-text text-muted mt-1">Confidence threshold for detecting faces
                                            in images. Higher values filter more strictly, only high-confidence
                                            detections will be kept</div>
                                    </div>

                                    <div class="config-item">
                                        <label for="duplicateThreshold" class="form-label">Duplicate Registration
                                            Threshold</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" id="duplicateThresholdRange"
                                                min="0.8" max="0.99" step="0.01" value="0.95">
                                            <input type="number" class="form-control" id="duplicateThreshold" min="0.8"
                                                max="0.99" step="0.01" value="0.95">
                                        </div>
                                        <small class="text-muted">Current: <span
                                                id="duplicateThresholdDisplay">0.85</span></small>
                                        <div class="form-text text-muted mt-1">
                                            Similarity threshold to prevent duplicate registration of the same person.
                                            When a new face's similarity to existing people with <strong>different
                                                names</strong> exceeds this threshold, registration will be rejected.
                                            Higher values make duplicate prevention stricter.
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-outline-secondary me-md-2"
                                            onclick="analytics.loadConfiguration()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                        </button>
                                        <button type="button" class="btn btn-primary"
                                            onclick="analytics.updateConfiguration()">
                                            <i class="bi bi-check-lg me-1"></i>Save Configuration
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- System Information -->
                        <div class="analytics-panel mt-3">
                            <div class="analytics-header">
                                <h5><i class="bi bi-info-circle-fill me-2"></i>System Information</h5>
                            </div>
                            <div class="analytics-content">
                                <div class="system-info">
                                    <div class="info-item">
                                        <strong>Current Model:</strong>
                                        <span id="currentModel">buffalo_l</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Execution Provider:</strong>
                                        <span id="currentProvider">CPU</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Max File Size:</strong>
                                        <span>10MB</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Supported Formats:</strong>
                                        <span>JPEG, PNG, WebP, AVIF</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="analytics-panel mt-3">
                            <div class="analytics-header">
                                <h5><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
                            </div>
                            <div class="analytics-content">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-warning btn-sm" onclick="clearCache()">
                                        <i class="bi bi-trash3 me-1"></i>Clear Cache
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="showApiDocs()">
                                        <i class="bi bi-book me-1"></i>API Documentation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Update Time -->
                <div class="text-center mt-4">
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        Last Updated: <span id="lastUpdateTime">Loading...</span>
                    </small>
                </div>
            </div>
        </div>
    </main>

    <!-- Person Detail Modal -->
    <div class="modal fade" id="personDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Person Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Dynamic content filled here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>
                        Delete Person
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container - Moved to bottom right corner -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>

    <!-- JavaScript Dependencies -->
    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Utility Modules -->
    <script src="assets/js/utils.js"></script>

    <!-- Feature Modules -->
    <script src="assets/js/recognition.js"></script>
    <script src="assets/js/enrollment.js"></script>
    <script src="assets/js/management.js"></script>
    <script src="assets/js/analytics.js"></script>

    <!-- Main Application Initialization -->
    <script>
        // Main Application Class
        class FaceRecognitionApp {
            constructor() {
                this.modules = {};
                this.init();
            }

            async init() {
                try {
                    console.log('initializationTabnavigation...');
                    this.initializeTabs();

                    // Initialize each module
                    this.modules.recognition = new FaceRecognition();
                    this.modules.enrollment = new PersonEnrollment();
                    this.modules.management = new PersonManagement();
                    this.modules.analytics = new Analytics();

                    console.log('Face recognition system initialization completed');
                    // Delete the initializedToasthintÔºåAvoid interfering with user operations
                    // The system has been initialized normallyÔºåNo additional prompts needed

                } catch (error) {
                    console.error('Application initialization failed:', error);
                    // even thoughToastTry to display error even if it fails.
                    try {
                        ToastManager.show('System initialization failed', 'error');
                    } catch (e) {
                        console.error('ToastThe system also failed');
                    }
                }
            }

            initializeTabs() {
                // make sureBootstrapLoaded
                if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrapnot loadedÔºÅ');
                    return;
                }

                // Manually initialize allTab
                const tabElements = document.querySelectorAll('[data-bs-toggle="tab"]');
                console.log(`turn up${tabElements.length}indivualtabelement`);

                tabElements.forEach((tabEl, index) => {
                    try {
                        // createBootstrap TabExample
                        const tab = new bootstrap.Tab(tabEl);
                        console.log(`Tab ${index + 1} Initialization successful:`, tabEl.getAttribute('data-bs-target'));

                        // Add click event listener
                        tabEl.addEventListener('click', (e) => {
                            e.preventDefault();
                            tab.show();
                            console.log('Tab clicked:', tabEl.getAttribute('data-bs-target'));
                        });

                    } catch (error) {
                        console.error(`Tab ${index + 1} Initialization failed:`, error);
                    }
                });

                // monitorTabSwitch event
                document.addEventListener('shown.bs.tab', (event) => {
                    const targetId = event.target.getAttribute('data-bs-target');
                    console.log('Tab switch to:', targetId);
                    this.onTabShown(targetId.substring(1));
                });
            }

            onTabShown(tabId) {
                console.log('deal withTabswitch:', tabId);
                // Processing logic when switching tabs
                switch (tabId) {
                    case 'management':
                        // Refresh person list
                        if (this.modules.management) {
                            this.modules.management.loadPersons();
                        }
                        break;
                    case 'analytics':
                        // Refresh statistics
                        if (this.modules.analytics) {
                            this.modules.analytics.loadData();
                        }
                        break;
                }
            }
        }

        // global function mappingÔºàCompatible with originalonclickeventÔºâ
        function clearEnrollment() {
            if (app.modules.enrollment) {
                app.modules.enrollment.clearEnrollment();
            }
        }

        function refreshPersonList() {
            if (app.modules.management) {
                app.modules.management.loadPersons();
                app.modules.management.addRecentOperation('Refresh data', 'Reload people list data');
            }
        }

        function showSortOptions() {
            if (app.modules.management) {
                app.modules.management.showSortOptions();
            }
        }

        function refreshStats() {
            if (app.modules.analytics) {
                app.modules.analytics.loadData();
            }
        }

        function saveConfig() {
            if (app.modules.analytics) {
                app.modules.analytics.saveConfiguration();
            }
        }

        // Special function for statistical analysis page
        function refreshAllData() {
            if (app.modules.analytics) {
                app.modules.analytics.loadData();
            }
        }

        function saveConfiguration() {
            if (app.modules.analytics) {
                app.modules.analytics.saveConfiguration();
            }
        }

        function exportStatistics() {
            if (app.modules.analytics) {
                app.modules.analytics.exportStats();
            } else {
                alert('Statistics module not loadedÔºåUnable to export data');
            }
        }

        function downloadSystemReport() {
            if (app.modules.analytics) {
                app.modules.analytics.downloadSystemReport();
            } else {
                alert('Statistics module not loadedÔºåUnable to download report');
            }
        }

        function clearCache() {
            if (app.modules.analytics) {
                app.modules.analytics.clearCache();
            } else {
                if (confirm('Are you sure you want to clear cache?Ôºü')) {
                    localStorage.clear();
                    sessionStorage.clear();
                    alert('cache cleared');
                    location.reload();
                }
            }
        }

        function showApiDocs() {
            if (app.modules.analytics) {
                app.modules.analytics.showApiDocs();
            } else {
                alert('API document\n\nMain interfaceÔºö\n- GET /api/statistics - Get statistics\n- POST /api/config - Save configuration\n- POST /api/recognize - face recognition\n- GET /api/persons - Get list of people');
            }
        }

        // Personnel management related functions
        function showBulkOperations() {
            // Switch batch operation panel display
            const panel = document.querySelector('.bulk-operations-panel');
            if (panel) {
                const isVisible = panel.style.display !== 'none';
                panel.style.display = isVisible ? 'none' : 'block';

                // If the display panelÔºåMake sure there is a select function
                if (!isVisible && app.modules.management) {
                    app.modules.management.enableBulkSelection();
                }
            }
        }

        function hideBulkOperations() {
            const panel = document.querySelector('.bulk-operations-panel');
            if (panel) {
                panel.style.display = 'none';
            }
            if (app.modules.management) {
                app.modules.management.disableBulkSelection();
            }
        }

        function selectAllPersons() {
            if (app.modules.management) {
                app.modules.management.selectAllPersons();
            }
        }

        function clearAllSelections() {
            if (app.modules.management) {
                app.modules.management.clearAllSelections();
            }
        }

        function exportSelectedPersons() {
            if (app.modules.management) {
                app.modules.management.exportSelectedPersons();
            }
        }

        function deleteSelectedPersons() {
            if (app.modules.management) {
                app.modules.management.bulkDeletePersons();
            }
        }

        function selectAllPersons() {
            if (app.modules.management) {
                app.modules.management.selectAllPersons();
            } else {
                // Simple implementation of selecting all
                const checkboxes = document.querySelectorAll('input[type="checkbox"][data-person-id]');
                checkboxes.forEach(cb => cb.checked = true);
                updateBulkButtons();
            }
        }

        function clearSelection() {
            if (app.modules.management) {
                app.modules.management.clearSelection();
            } else {
                // Simple clear selection implementation
                const checkboxes = document.querySelectorAll('input[type="checkbox"][data-person-id]');
                checkboxes.forEach(cb => cb.checked = false);
                updateBulkButtons();
            }
        }

        function bulkDeletePersons() {
            const selected = document.querySelectorAll('input[type="checkbox"][data-person-id]:checked');
            if (selected.length === 0) {
                alert('Please select the person you want to delete first');
                return;
            }

            if (confirm(`Are you sure you want to delete the selected ${selected.length} Personnel?ÔºüThis action is irreversible„ÄÇ`)) {
                if (app.modules.management) {
                    app.modules.management.bulkDeletePersons();
                } else {
                    alert('The batch deletion function is under development...');
                }
            }
        }

        function exportSelectedPersons() {
            const selected = document.querySelectorAll('input[type="checkbox"][data-person-id]:checked');
            if (selected.length === 0) {
                alert('Please select the person you want to export first');
                return;
            }

            if (app.modules.management) {
                app.modules.management.exportSelectedPersons();
            } else {
                alert('Batch export function is under development...');
            }
        }

        function updateBulkButtons() {
            const selected = document.querySelectorAll('input[type="checkbox"][data-person-id]:checked');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const bulkExportBtn = document.getElementById('bulkExportBtn');

            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = selected.length === 0;
            }
            if (bulkExportBtn) {
                bulkExportBtn.disabled = selected.length === 0;
            }
        }

        // New global function
        function clearRecognition() {
            if (app.modules.recognition) {
                app.modules.recognition.clearRecognition();
            }
        }

        // Camera recognition related functions
        function clearRecognitionHistory() {
            const historyList = document.getElementById('historyList');
            if (historyList) {
                historyList.innerHTML = '';
            }
            const recognitionHistory = document.getElementById('recognitionHistory');
            if (recognitionHistory) {
                recognitionHistory.style.display = 'none';
            }
        }

        function clearImagePreview() {
            if (app.modules.recognition) {
                app.modules.recognition.clearRecognition();
            }
        }

        function downloadResult() {
            // TODO: Implement the function of downloading recognition results
            if (window.ToastManager) {
                ToastManager.show('Download function is under development...', 'info');
            } else {
                alert('Download function is under development...');
            }
        }

        function downloadVisualization(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = `face_recognition_result_${new Date().getTime()}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            if (window.ToastManager) {
                ToastManager.show('Visualization results downloaded', 'success');
            } else {
                alert('Visualization results downloaded');
            }
        }

        function showImageModal(url) {
            // Create a simple modal box to display a large image
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Recognition result details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${url}" class="img-fluid" alt="Recognition result details">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            if (window.bootstrap) {
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();

                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
            } else {
                // Simple picture viewer
                window.open(url, '_blank');
                document.body.removeChild(modal);
            }
        }

        function showEnrollmentModal() {
            // Switch to registration tab
            const enrollmentTab = document.getElementById('enrollment-tab');
            if (enrollmentTab) {
                if (window.bootstrap) {
                    const tab = new bootstrap.Tab(enrollmentTab);
                    tab.show();
                } else {
                    // Simple tab switching
                    enrollmentTab.click();
                }

                if (window.ToastManager) {
                    ToastManager.show('Switched to personnel registration page', 'info');
                }
            }
        }

        // Registration Mode Switching Functionality
        function switchRegistrationMode(mode, element) {
            console.log(`switchRegistrationMode called with mode: ${mode}`);

            // Prevent any event bubbling that could trigger tab switching
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }

            const photoModeRadio = document.getElementById('photoMode');
            const videoModeRadio = document.getElementById('videoMode');
            const photoUploadSection = document.getElementById('photoUploadSection');
            const videoRegistrationSection = document.getElementById('videoRegistrationSection');

            // Get all custom radio buttons
            const allCustomButtons = document.querySelectorAll('.custom-radio-btn');

            if (!photoModeRadio || !videoModeRadio || !photoUploadSection || !videoRegistrationSection) {
                console.error('Required registration mode elements not found');
                return false;
            }

            // Ensure we're staying in the enrollment tab
            const currentTab = document.querySelector('#mainTabContent .tab-pane.show.active');
            if (currentTab && currentTab.id !== 'enrollment') {
                console.log('Ensuring we stay in enrollment tab');
                const enrollmentTab = document.getElementById('enrollment-tab');
                if (enrollmentTab && window.bootstrap) {
                    const tab = new bootstrap.Tab(enrollmentTab);
                    tab.show();
                }
            }

            // Update radio button states
            if (mode === 'photo') {
                photoModeRadio.checked = true;
                videoModeRadio.checked = false;

                // Show/hide appropriate sections
                photoUploadSection.style.display = 'block';
                videoRegistrationSection.style.display = 'none';

                // Stop video registration if running
                if (typeof stopVideoRegistration === 'function') {
                    stopVideoRegistration();
                }

                console.log('‚úì Switched to photo upload mode');

            } else if (mode === 'video') {
                photoModeRadio.checked = false;
                videoModeRadio.checked = true;

                // Show/hide appropriate sections
                photoUploadSection.style.display = 'none';
                videoRegistrationSection.style.display = 'block';

                // Immediately start video registration (like live detection)
                setTimeout(() => {
                    startVideoRegistrationImmediately();
                }, 100);

                console.log('‚úì Switched to video registration mode');
            }

            // Update button active states
            allCustomButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            if (element) {
                element.classList.add('active');
            }

            return false; // Prevent further event propagation
        }

        function initializeRegistrationModes() {
            console.log('Initialize registration mode switching function...');

            const photoModeRadio = document.getElementById('photoMode');
            const videoModeRadio = document.getElementById('videoMode');
            const photoUploadSection = document.getElementById('photoUploadSection');
            const videoRegistrationSection = document.getElementById('videoRegistrationSection');

            if (!photoModeRadio || !videoModeRadio || !photoUploadSection || !videoRegistrationSection) {
                console.error('Registration mode element not found');
                return;
            }

            // deal withPhotoMode selection
            photoModeRadio.addEventListener('change', function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (this.checked) {
                    console.log('Switch to photo upload mode');
                    photoUploadSection.style.display = 'block';
                    videoRegistrationSection.style.display = 'none';

                    // Stop video streamingÔºàif runningÔºâ
                    stopVideoRegistration();
                }
            });

            // deal withVideoMode selection
            videoModeRadio.addEventListener('change', function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (this.checked) {
                    console.log('Switch to video registration mode');
                    photoUploadSection.style.display = 'none';
                    videoRegistrationSection.style.display = 'block';

                    // Start video registration nowÔºàpicturelive detectionSameÔºâ
                    setTimeout(() => {
                        startVideoRegistrationImmediately();
                    }, 100);
                }
            });

            // Prevent label clicks from triggeringTabswitch
            const photoModeLabel = document.querySelector('label[for="photoMode"]');
            const videoModeLabel = document.querySelector('label[for="videoMode"]');

            if (photoModeLabel) {
                photoModeLabel.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('PhotoMode label clickedÔºåSwitch mode');
                    photoModeRadio.checked = true;
                    photoModeRadio.dispatchEvent(new Event('change'));
                });
            }

            if (videoModeLabel) {
                videoModeLabel.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('VideoMode label clickedÔºåSwitch mode');
                    videoModeRadio.checked = true;
                    videoModeRadio.dispatchEvent(new Event('change'));
                });
            }

            console.log('Registration mode switching function initialization completed');
        }

        // Video Registration functionality
        let videoRegistrationStream = null;
        let isVideoRegistrationActive = false;
        let registrationFrames = [];
        window.registrationFrames = registrationFrames; // Make accessible globally for enrollment
        let recordingInterval = null;
        let recordingCountdown = null;

        function initializeVideoRegistration() {
            console.log('Initialize video registration function...');

            const startBtn = document.getElementById('startVideoRegistrationBtn');
            const stopBtn = document.getElementById('stopVideoRegistrationBtn');
            const retakeBtn = document.getElementById('retakeVideoBtn');

            if (startBtn) {
                startBtn.removeEventListener('click', startVideoRegistration);
                startBtn.addEventListener('click', startVideoRegistration);
            }
            if (stopBtn) {
                stopBtn.removeEventListener('click', stopVideoRegistration);
                stopBtn.addEventListener('click', stopVideoRegistration);
            }
            if (retakeBtn) {
                retakeBtn.removeEventListener('click', retakeVideoRegistration);
                retakeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    retakeVideoRegistration();
                    return false;
                });
            }
        }

        // Function to immediately start video registration when switching to video mode
        async function startVideoRegistrationImmediately() {
            console.log('Start video registration nowÔºàSimilar to real-time detectionÔºâ...');

            try {
                const video = document.getElementById('registrationVideo');
                const placeholder = document.getElementById('registrationPlaceholder');
                const status = document.getElementById('registrationStatus');
                const indicator = document.getElementById('faceDetectionIndicator');
                const detectionMessage = document.getElementById('detectionMessage');

                if (!video || !status) {
                    console.error('Video element not found');
                    return;
                }

                // Update UI to show camera is starting
                video.style.display = 'block';
                if (placeholder) placeholder.style.display = 'none';

                status.style.display = 'block';
                status.className = 'webcam-status active';
                status.innerHTML = '<i class="bi bi-camera-video-fill me-1"></i><span>Requesting camera access...</span>';

                if (indicator) {
                    indicator.style.display = 'block';
                    if (detectionMessage) {
                        detectionMessage.textContent = 'Initializing camera for video registration...';
                    }
                }

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Browser does not support camera access');
                }

                // Request camera access
                videoRegistrationStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });

                // Set video stream
                video.srcObject = videoRegistrationStream;
                await video.play();

                // Update status
                status.innerHTML = '<i class="bi bi-check-circle me-1"></i><span>Camera ready! Recording will start in 3 seconds...</span>';

                if (detectionMessage) {
                    detectionMessage.textContent = 'Position your face in the camera. Recording will start automatically...';
                }

                isVideoRegistrationActive = true;

                // Initialize the recording controls
                initializeVideoRegistration();

                // Start countdown then recording
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        status.innerHTML = `<i class="bi bi-hourglass-split me-1"></i><span>Recording starts in ${countdown} seconds...</span>`;
                        if (detectionMessage) {
                            detectionMessage.textContent = `Get ready! Recording starts in ${countdown}...`;
                        }
                    } else {
                        clearInterval(countdownInterval);
                        // Start the actual recording
                        if (videoRegistrationStream) {
                            startRecording();
                        }
                    }
                }, 1000);

                if (window.ToastManager) {
                    ToastManager.show('Camera activated! Recording will begin shortly...', 'success');
                }

            } catch (error) {
                console.error('Failed to start video registration:', error);

                let errorMessage = 'Failed to start camera';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Camera access denied. Please allow camera permissions.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera device found.';
                }

                // Update UI to show error
                const status = document.getElementById('registrationStatus');
                if (status) {
                    status.className = 'webcam-status';
                    status.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i><span>${errorMessage}</span>`;
                }

                const indicator = document.getElementById('faceDetectionIndicator');
                const detectionMessage = document.getElementById('detectionMessage');
                if (indicator && detectionMessage) {
                    indicator.className = 'face-detection-indicator';
                    indicator.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-2"></i><strong>Error!</strong> ${errorMessage}</div>`;
                }

                if (window.ToastManager) {
                    ToastManager.show(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
            }
        }

        async function startVideoRegistration() {
            console.log('Start video registration...');

            try {
                const video = document.getElementById('registrationVideo');
                const placeholder = document.getElementById('registrationPlaceholder');
                const status = document.getElementById('registrationStatus');
                const startBtn = document.getElementById('startVideoRegistrationBtn');
                const stopBtn = document.getElementById('stopVideoRegistrationBtn');

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('The browser does not support camera access');
                }

                // Request camera permission
                videoRegistrationStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });

                // Set up video streaming
                video.srcObject = videoRegistrationStream;
                await video.play();

                // show videoÔºåHide placeholder
                video.style.display = 'block';
                placeholder.style.display = 'none';

                // update status
                status.innerHTML = '<i class="bi bi-camera-video-fill me-1"></i><span>Camera is activatedÔºåPrepare to record</span>';
                status.style.display = 'block';

                // Update button state
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';

                // Show face detection indicator
                showFaceDetectionIndicator();

                // start5Record in seconds
                setTimeout(() => {
                    if (videoRegistrationStream) {
                        startRecording();
                    }
                }, 2000); // 2Start recording in seconds

                isVideoRegistrationActive = true;

                if (window.ToastManager) {
                    ToastManager.show('Camera started successfullyÔºå2Start recording in seconds', 'success');
                }

            } catch (error) {
                console.error('Video registration failed to start:', error);

                let errorMessage = 'Camera startup failed';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Camera access deniedÔºåPlease allow camera permissions';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'Camera device not found';
                }

                if (window.ToastManager) {
                    ToastManager.show(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
            }
        }

        function showFaceDetectionIndicator() {
            const indicator = document.getElementById('faceDetectionIndicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function startRecording() {
            console.log('start5Record in seconds...');

            const progressBar = document.getElementById('recordingProgressBar');
            const countdown = document.getElementById('recordingCountdown');
            const progress = document.getElementById('recordingProgress');
            const status = document.getElementById('registrationStatus');

            // Show progress bar
            if (progress) {
                progress.style.display = 'block';
            }

            // update status
            if (status) {
                status.innerHTML = '<i class="bi bi-record-circle me-1"></i><span>Recording...</span>';
                status.className = 'webcam-status recording';
            }

            let secondsLeft = 5;
            let progress_percent = 0;

            // Capture first frame immediately
            captureRegistrationFrame();
            console.log('Capture first frame immediately');

            recordingCountdown = setInterval(() => {
                secondsLeft--;
                progress_percent = ((5 - secondsLeft) / 5) * 100;

                if (progressBar) {
                    progressBar.style.width = progress_percent + '%';
                }

                if (countdown) {
                    countdown.textContent = secondsLeft;
                }

                // capture one frame per second
                if (secondsLeft > 0) {
                    captureRegistrationFrame();
                    console.log(`Capture No. ${6 - secondsLeft} frame`);
                }

                if (secondsLeft <= 0) {
                    clearInterval(recordingCountdown);
                    // Give the last frame some time to process
                    setTimeout(() => {
                        finishRecording();
                    }, 100);
                }
            }, 1000);
        }

        function captureRegistrationFrame() {
            const video = document.getElementById('registrationVideo');
            if (!video) {
                console.error('Video element not found');
                return;
            }

            if (video.readyState !== 4) {
                console.warn('Video is not ready yetÔºåSkip this frame');
                return;
            }

            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                if (canvas.width === 0 || canvas.height === 0) {
                    console.warn('The video size is0ÔºåSkip this frame');
                    return;
                }

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                canvas.toBlob((blob) => {
                    if (blob) {
                        registrationFrames.push(blob);
                        window.registrationFrames = registrationFrames; // Update global reference
                        console.log(`‚úì Frame captured successfully ${registrationFrames.length}/5 (size: ${Math.round(blob.size / 1024)}KB)`);
                    } else {
                        console.error('Failed to capture frame: blobis empty');
                    }
                }, 'image/jpeg', 0.8);

            } catch (error) {
                console.error('Capture frame exception:', error);
            }
        }

        function finishRecording() {
            console.log('Recording completedÔºåcaptured', registrationFrames.length, 'frame');
            console.log('final frame data:', registrationFrames.map((blob, i) => ({ frame: i + 1, size: Math.round(blob.size / 1024) + 'KB' })));

            const progress = document.getElementById('recordingProgress');
            const status = document.getElementById('registrationStatus');
            const stopBtn = document.getElementById('stopVideoRegistrationBtn');
            const retakeBtn = document.getElementById('retakeVideoBtn');
            const video = document.getElementById('registrationVideo');
            const placeholder = document.getElementById('registrationPlaceholder');

            // Hide progress bar
            if (progress) {
                progress.style.display = 'none';
            }

            // Stop camera stream automatically after recording is complete
            if (videoRegistrationStream) {
                console.log('Automatically stop camera stream...');
                videoRegistrationStream.getTracks().forEach(track => track.stop());
                videoRegistrationStream = null;
            }

            // Hide video and show placeholder
            if (video) {
                video.style.display = 'none';
                video.srcObject = null;
            }
            if (placeholder) {
                placeholder.style.display = 'flex';
            }

            // update status
            if (status) {
                status.innerHTML = '<i class="bi bi-check-circle me-1"></i><span>Recording completedÔºåcamera is off</span>';
                status.className = 'webcam-status';
            }

            // update button
            if (stopBtn) {
                stopBtn.style.display = 'none';
            }
            if (retakeBtn) {
                retakeBtn.style.display = 'block';
            }

            // Show captured frame preview
            showCapturedFrames();

            // Enable registration button
            const enrollBtn = document.getElementById('enrollBtn');
            if (enrollBtn) {
                enrollBtn.disabled = false;
            }

            // Mark as inactive
            isVideoRegistrationActive = false;

            if (window.ToastManager) {
                ToastManager.show(`Recording completedÔºåcaptured ${registrationFrames.length} frameÔºåThe camera has automatically turned off`, 'success');
            }
        }

        function showCapturedFrames() {
            console.log('Show captured frame previewÔºånumber of frames:', registrationFrames.length);
            console.log('Frame data details:', registrationFrames.map((blob, i) => ({ index: i + 1, size: Math.round(blob.size / 1024) + 'KB', type: blob.type })));

            const previewSection = document.getElementById('videoPreviewSection');
            const framesContainer = document.getElementById('capturedFrames');
            const frameCount = document.getElementById('frameCount');

            if (!previewSection || !framesContainer) {
                console.warn('Preview container element not found');
                return;
            }

            previewSection.style.display = 'block';

            if (frameCount) {
                frameCount.textContent = registrationFrames.length;
            }

            framesContainer.innerHTML = '';

            if (registrationFrames.length === 0) {
                framesContainer.innerHTML = '<div class="col-12 text-center text-muted">No frame data captured</div>';
                return;
            }

            registrationFrames.forEach((blob, index) => {
                try {
                    const url = URL.createObjectURL(blob);
                    const frameDiv = document.createElement('div');
                    // Use smaller column widths to fit5frame
                    frameDiv.className = 'col-2 col-md-2';
                    frameDiv.innerHTML = `
                        <div class="captured-frame">
                            <img src="${url}" alt="Frame ${index + 1}" onload="console.log('frame ${index + 1} Loading successfully')" onerror="console.error('frame ${index + 1} Loading failed')">
                            <div class="frame-number">${index + 1}</div>
                        </div>
                    `;
                    framesContainer.appendChild(frameDiv);
                    console.log(`‚úì frame ${index + 1} Preview created`);
                } catch (error) {
                    console.error(`Create frame ${index + 1} Preview failed:`, error);
                }
            });

            console.log('‚úì Frame preview display completed');
        }

        function stopVideoRegistration() {
            console.log('Stop video registration...');

            if (recordingCountdown) {
                clearInterval(recordingCountdown);
                recordingCountdown = null;
            }

            if (videoRegistrationStream) {
                videoRegistrationStream.getTracks().forEach(track => track.stop());
                videoRegistrationStream = null;
            }

            const video = document.getElementById('registrationVideo');
            const placeholder = document.getElementById('registrationPlaceholder');
            const status = document.getElementById('registrationStatus');
            const startBtn = document.getElementById('startVideoRegistrationBtn');
            const stopBtn = document.getElementById('stopVideoRegistrationBtn');
            const progress = document.getElementById('recordingProgress');
            const indicator = document.getElementById('faceDetectionIndicator');

            // Reset interface
            if (video) {
                video.style.display = 'none';
                video.srcObject = null;
            }
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
            if (status) {
                status.style.display = 'none';
            }
            if (progress) {
                progress.style.display = 'none';
            }
            if (indicator) {
                indicator.style.display = 'none';
            }

            // reset button
            if (startBtn) {
                startBtn.style.display = 'block';
            }
            if (stopBtn) {
                stopBtn.style.display = 'none';
            }

            isVideoRegistrationActive = false;

            if (window.ToastManager) {
                ToastManager.show('Video registration has stopped', 'info');
            }
        }

        function retakeVideoRegistration() {
            console.log('Rerecord video...');

            // Prevent any navigation or tab switching
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            // Clear previous frames
            registrationFrames = [];
            window.registrationFrames = []; // Clear global reference too
            console.log('‚úì Previously captured frame data cleared');

            // Hide preview
            const previewSection = document.getElementById('videoPreviewSection');
            if (previewSection) {
                previewSection.style.display = 'none';
            }

            // Clear preview frame container
            const framesContainer = document.getElementById('capturedFrames');
            if (framesContainer) {
                framesContainer.innerHTML = '';
                console.log('‚úì Frame preview container cleared');
            }

            // Hide rerecord button
            const retakeBtn = document.getElementById('retakeVideoBtn');
            if (retakeBtn) {
                retakeBtn.style.display = 'none';
            }

            // Disable registration button
            const enrollBtn = document.getElementById('enrollBtn');
            if (enrollBtn) {
                enrollBtn.disabled = true;
                enrollBtn.innerHTML = '<i class="bi bi-person-plus me-1"></i>Registered Person';
            }

            // Make sure to stay in video mode
            const videoMode = document.getElementById('videoMode');
            if (videoMode && !videoMode.checked) {
                videoMode.checked = true;
            }

            // Reset UI elements to show camera is starting
            const video = document.getElementById('registrationVideo');
            const placeholder = document.getElementById('registrationPlaceholder');
            const status = document.getElementById('registrationStatus');
            const indicator = document.getElementById('faceDetectionIndicator');
            const detectionMessage = document.getElementById('detectionMessage');

            if (video) {
                video.style.display = 'block';
                video.srcObject = null; // Clear any previous stream
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            if (status) {
                status.style.display = 'block';
                status.className = 'webcam-status active';
                status.innerHTML = '<i class="bi bi-camera-video-fill me-1"></i><span>Restart camera...</span>';
            }
            if (indicator) {
                indicator.style.display = 'block';
                if (detectionMessage) {
                    detectionMessage.textContent = 'Restarting video registration...';
                    detectionMessage.className = 'alert alert-info mb-0';
                }
            }

            // reset state variables
            isVideoRegistrationActive = false;

            // Clean up any existing timers
            if (recordingInterval) {
                clearInterval(recordingInterval);
                recordingInterval = null;
            }
            if (recordingCountdown) {
                clearInterval(recordingCountdown);
                recordingCountdown = null;
            }

            // Restart video registrationÔºàUse direct startupÔºâ
            setTimeout(() => {
                startVideoRegistrationImmediately();
            }, 100);

            if (window.ToastManager) {
                ToastManager.show('Restarting cameraÔºåPrevious frame data has been cleared', 'info');
            }

            return false; // Prevent any default behavior
        }

        // Start application
        let app;
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOMLoading completedÔºåStart application...');

            // Force initialization firstTabnavigationÔºàDoes not depend on other modulesÔºâ
            initializeTabsDirectly();

            // Initialize registration mode switch
            setTimeout(() => {
                initializeRegistrationModes();
            }, 500);

            // Then initialize the main application
            try {
                app = new FaceRecognitionApp();

                // Set global references for debugging
                window.app = app;
                window.personManagement = app.modules.management;
                window.analytics = app.modules.analytics;
            } catch (error) {
                console.error('Main application initialization failedÔºåbutTabNavigation is still available:', error);
            }
        });

        // direct initializationTabNavigation functions
        function initializeTabsDirectly() {
            console.log('direct initializationTabnavigation...');

            // waitBootstrapload
            const waitForBootstrap = setInterval(() => {
                if (typeof bootstrap !== 'undefined') {
                    clearInterval(waitForBootstrap);

                    const tabElements = document.querySelectorAll('[data-bs-toggle="tab"]');
                    console.log(`turn up${tabElements.length}indivualtabelement`);

                    tabElements.forEach((tabEl, index) => {
                        try {
                            // createBootstrap TabExample
                            const tab = new bootstrap.Tab(tabEl);
                            console.log(`Tab ${index + 1} Initialization successful`);

                            // Add click event listener
                            tabEl.addEventListener('click', function (e) {
                                e.preventDefault();
                                tab.show();
                                console.log('Tabswitch to:', this.getAttribute('data-bs-target'));
                            });

                        } catch (error) {
                            console.error(`Tab ${index + 1} Initialization failed:`, error);
                        }
                    });

                    // monitorTabSwitch event
                    document.addEventListener('shown.bs.tab', function (event) {
                        const targetId = event.target.getAttribute('data-bs-target');
                        console.log('TabSwitch completed:', targetId);

                        // Call the corresponding processing function
                        if (window.app && window.app.onTabShown) {
                            window.app.onTabShown(targetId.substring(1));
                        }
                    });

                    console.log('TabNavigation initialization completed');
                }
            }, 100);
        }

        // Camera real-time recognition class
        class WebcamRecognition {
            constructor() {
                this.stream = null;
                this.video = null;
                this.canvas = null;
                this.ctx = null;
                this.isRunning = false;
                this.recognitionInterval = null;
                this.intervalTime = 1000; // The default recognition interval is1Second
                this.resultsCount = 0;
                this.recognitionHistory = [];
                this.matchConfirmations = {}; // Track match confirmations
                this.confirmationThreshold = 2; // Need 2 confirmations

                this.init();
            }

            init() {
                console.log('Initialize the camera recognition system...');

                // GetDOMelement
                this.video = document.getElementById('webcamVideo');
                this.startBtn = document.getElementById('startWebcamBtn');
                this.stopBtn = document.getElementById('stopWebcamBtn');
                this.webcamContainer = document.getElementById('webcamContainer');
                this.webcamPlaceholder = document.getElementById('webcamPlaceholder');
                this.webcamStatus = document.getElementById('webcamStatus');
                this.liveResults = document.getElementById('liveRecognitionResults');
                this.intervalSlider = document.getElementById('recognitionInterval');
                this.intervalDisplay = document.getElementById('recognitionFrequency');
                this.resultsCounter = document.getElementById('liveResultsCount');
                this.cameraSelect = document.getElementById('cameraSelect');

                // create hiddencanvasUsed to capture frames
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');

                // Binding events
                this.bindEvents();

                // Detect camera equipment
                this.enumerateDevices();

                console.log('Camera recognition system initialization completed');
            }

            bindEvents() {
                if (this.startBtn) {
                    this.startBtn.addEventListener('click', () => this.startWebcam());
                }

                if (this.stopBtn) {
                    this.stopBtn.addEventListener('click', () => this.stopWebcam());
                }

                // Add retry button handler
                const retryBtn = document.getElementById('retryRecognitionBtn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => this.retryRecognition());
                }

                if (this.intervalSlider) {
                    this.intervalSlider.addEventListener('input', (e) => {
                        this.intervalTime = parseInt(e.target.value) * 1000;
                        this.updateIntervalDisplay(parseInt(e.target.value));

                        // if runningÔºåUpdate recognition interval
                        if (this.isRunning) {
                            this.restartRecognitionLoop();
                        }
                    });
                }
            }
            
            retryRecognition() {
                // Reset confirmations and clear results
                this.matchConfirmations = {};
                
                // Clear live results
                if (this.liveResults) {
                    this.liveResults.innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-camera-video"></i>
                            <h6>Waiting for Camera</h6>
                            <p class="mb-0">Live recognition results will appear after starting the camera</p>
                        </div>
                    `;
                }
                
                // Reset results count
                this.resultsCount = 0;
                this.recognitionHistory = [];
                this.updateResultsCount();
                
                // Hide retry button and show start button
                const retryBtn = document.getElementById('retryRecognitionBtn');
                if (retryBtn) {
                    retryBtn.style.display = 'none';
                }
                
                // Start webcam again
                this.startWebcam();
            }

            updateIntervalDisplay(seconds) {
                if (this.intervalDisplay) {
                    this.intervalDisplay.textContent = `Every ${seconds}s`;
                }
            }

            async startWebcam() {
                try {
                    console.log('==== Start camera ====');

                    // Check basic permissions support
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('The browser does not support camera access');
                    }

                    // Get the selected camera device value
                    const selectedValue = this.cameraSelect ? this.cameraSelect.value : '';
                    const selectedText = this.cameraSelect ? this.cameraSelect.options[this.cameraSelect.selectedIndex].textContent : '';
                    console.log(`User selected device: "${selectedText}" (value: "${selectedValue}")`);

                    // Build basic constraints
                    const constraints = {
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            frameRate: { ideal: 30 }
                        }
                    };

                    console.log('Basic constraints:', JSON.stringify(constraints, null, 2));

                    // Set constraints based on selected device type
                    if (selectedValue && selectedValue.startsWith('device')) {
                        console.log(`Handling fallback device options: ${selectedValue}`);

                        // If the backup device optionÔºåRequires special handling
                        if (selectedValue === 'device2') {
                            console.log('Try to access device index 2 (Users work camera)...');

                            try {
                                // Enumerate devices firstÔºåGet real deviceID
                                console.log('Enumerate devices to get the device 2 of realityID...');
                                const devices = await navigator.mediaDevices.enumerateDevices();
                                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                                console.log(`turn up ${videoDevices.length} video device:`);
                                videoDevices.forEach((device, index) => {
                                    console.log(`  equipment ${index}: ${device.label || '[no label]'} (ID: ${device.deviceId.substring(0, 20)}...)`);
                                });

                                if (videoDevices.length > 2) {
                                    const targetDevice = videoDevices[2];
                                    constraints.video.deviceId = { exact: targetDevice.deviceId };
                                    console.log(`‚úì Use device index 2 of realityID: ${targetDevice.deviceId.substring(0, 20)}... (${targetDevice.label || 'no label'})`);
                                } else {
                                    console.log('‚ö† Device index 2 does not existÔºåFallback to default device');
                                    // If there is any equipmentÔºåUse the last oneÔºåOtherwise use default
                                    if (videoDevices.length > 0) {
                                        const lastDevice = videoDevices[videoDevices.length - 1];
                                        constraints.video.deviceId = { exact: lastDevice.deviceId };
                                        console.log(`Use last device: ${lastDevice.label || 'no label'}`);
                                    } else {
                                        constraints.video.facingMode = 'user';
                                        console.log('Use default user camera settings');
                                    }
                                }
                            } catch (enumError) {
                                console.warn('Device enumeration failedÔºåUse default settings:', enumError.message);
                                constraints.video.facingMode = 'user';
                            }
                        } else {
                            console.log(`Handle other fallback device options: ${selectedValue}`);
                            constraints.video.facingMode = 'user';
                        }
                    } else if (selectedValue && selectedValue.length > 0) {
                        // If there is a real deviceIDÔºåUse directly
                        console.log(`Use the specified real deviceID: ${selectedValue.substring(0, 20)}...`);
                        constraints.video.deviceId = { exact: selectedValue };
                    } else {
                        // Completely default settings
                        console.log('Use completely default camera settings');
                        constraints.video.facingMode = 'user';
                    }

                    console.log('Final constraint configuration:', JSON.stringify(constraints, null, 2));

                    // The update status is„ÄåRequesting permission„Äç
                    this.updateResultsPanel('Requesting camera permission...', 'info');

                    // Request camera permission
                    console.log('send getUserMedia ask...');
                    const startTime = Date.now();

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);

                    const requestTime = Date.now() - startTime;
                    console.log(`‚úì getUserMedia success (time: ${requestTime}ms)`);

                    // Check basic information about the stream
                    const tracks = this.stream.getVideoTracks();
                    if (tracks.length === 0) {
                        throw new Error('There is no video track in the obtained media stream');
                    }

                    const videoTrack = tracks[0];
                    const settings = videoTrack.getSettings();
                    console.log('Video track settings:', {
                        deviceId: settings.deviceId ? settings.deviceId.substring(0, 20) + '...' : 'N/A',
                        label: videoTrack.label || 'no label',
                        width: settings.width,
                        height: settings.height,
                        frameRate: settings.frameRate
                    });

                    // The update status is„ÄåInitializing video„Äç
                    this.updateResultsPanel('Camera permission has been obtainedÔºåInitializing video...');

                    // Set up video streaming
                    console.log('Set video streaming tovideoelement...');
                    this.video.srcObject = this.stream;

                    // Wait for the video to load and start playing
                    console.log('Wait for video metadata to load...');
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Video loading timeout'));
                        }, 10000); // 10seconds timeout

                        this.video.onloadedmetadata = () => {
                            clearTimeout(timeout);
                            console.log(`‚úì Video metadata loaded (${this.video.videoWidth}x${this.video.videoHeight})`);
                            resolve();
                        };

                        this.video.onerror = (error) => {
                            clearTimeout(timeout);
                            console.error('Video element error:', error);
                            reject(new Error('Video loading failed'));
                        };
                    });

                    // Make sure the video starts playing
                    try {
                        await this.video.play();
                        console.log('‚úì Video starts playing');
                    } catch (playError) {
                        console.warn('Video autoplay failed:', playError.message);
                        // This is usually not a fatal errorÔºåVideo may still work
                    }

                    // show videoÔºåHide placeholder
                    console.log('renewUIstate...');
                    this.video.style.display = 'block';
                    this.webcamPlaceholder.style.display = 'none';
                    this.webcamContainer.classList.add('active');

                    // Update button state
                    this.startBtn.style.display = 'none';
                    this.stopBtn.style.display = 'block';

                    // Show success status
                    this.webcamStatus.style.display = 'block';
                    this.webcamStatus.className = 'webcam-status active';
                    this.webcamStatus.innerHTML = '<i class="bi bi-camera-video-fill me-1"></i>Camera is activated';

                    // Update results panel
                    this.updateResultsPanel('Camera started successfullyÔºåReady to start real-time recognition...');

                    // Start identification loop
                    console.log('Start identification loop...');
                    this.isRunning = true;
                    this.startRecognitionLoop();

                    console.log('==== Camera startup completed ====');

                    if (window.ToastManager) {
                        ToastManager.show(`Camera started successfully (${settings.width}x${settings.height})`, 'success');
                    }

                } catch (error) {
                    console.error('==== Camera startup failed ====');
                    console.error('error name:', error.name);
                    console.error('error message:', error.message);
                    console.error('complete error:', error);

                    let userMessage = 'Camera startup failed';
                    let detailMessage = error.message || 'unknown error';

                    switch (error.name) {
                        case 'NotAllowedError':
                            userMessage = 'Camera access denied';
                            detailMessage = 'Please allow camera permissions in your browserÔºåThen refresh the page and try again';
                            break;
                        case 'NotFoundError':
                            userMessage = 'Camera device not found';
                            detailMessage = 'Please make sure the camera is connectedÔºåOr try choosing a different device';
                            break;
                        case 'NotReadableError':
                            userMessage = 'The camera is occupied or inaccessible';
                            detailMessage = 'Please close other applications that use the cameraÔºåthen try again';
                            break;
                        case 'OverconstrainedError':
                            userMessage = 'Camera settings are incompatible';
                            detailMessage = 'The selected device does not support the requested settingÔºåPlease try another device';
                            break;
                        case 'SecurityError':
                            userMessage = 'security restrictions';
                            detailMessage = 'Please use HTTPS or localhost visit this page';
                            break;
                        case 'TypeError':
                            userMessage = 'Device configuration error';
                            detailMessage = 'Device constraints are configured incorrectlyÔºåPlease try another device';
                            break;
                        default:
                            if (error.message.includes('time out')) {
                                userMessage = 'Camera initialization timeout';
                                detailMessage = 'Device responds slowlyÔºåPlease try again later or select a different device';
                            }
                            break;
                    }

                    // Clean status
                    this.isRunning = false;
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                        this.stream = null;
                    }

                    // renewUI
                    this.video.style.display = 'none';
                    this.webcamPlaceholder.style.display = 'flex';
                    this.webcamContainer.classList.remove('active');
                    this.webcamStatus.style.display = 'none';
                    this.startBtn.style.display = 'block';
                    this.stopBtn.style.display = 'none';

                    this.updateResultsPanel(`${userMessage}: ${detailMessage}`, 'error');

                    const fullMessage = `${userMessage}\n\n${detailMessage}`;

                    if (window.ToastManager) {
                        ToastManager.show(fullMessage, 'error');
                    } else {
                        alert(fullMessage);
                    }

                    console.log('Users are prompted to check the following items:');
                    console.log('1. Does the browser have camera permissions?');
                    console.log('2. Is the camera occupied by other applications?');
                    console.log('3. whether in security context (HTTPS/localhost) Visit in');
                    console.log('4. Try different camera devices');
                }
            }

            stopWebcam() {
                console.log('Stopping camera...');

                // Stop recognition loop
                this.isRunning = false;
                if (this.recognitionInterval) {
                    clearInterval(this.recognitionInterval);
                    this.recognitionInterval = null;
                }

                // Stop video streaming
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }

                // Reset interface
                this.video.style.display = 'none';
                this.webcamPlaceholder.style.display = 'flex';
                this.webcamContainer.classList.remove('active');
                this.webcamStatus.style.display = 'none';

                // Update button state
                this.startBtn.style.display = 'none';
                this.stopBtn.style.display = 'none';
                
                // Show retry button
                const retryBtn = document.getElementById('retryRecognitionBtn');
                if (retryBtn) {
                    retryBtn.style.display = 'block';
                }

                // Update results panel
                this.updateResultsPanel('Recognition complete. Click Retry to recognize again.');

                console.log('The camera has stopped');

                if (window.ToastManager) {
                    ToastManager.show('Recognition complete', 'success');
                }
            }

            startRecognitionLoop() {
                if (!this.isRunning) return;

                // Wait for an interval before starting the first recognition
                setTimeout(() => {
                    if (this.isRunning) {
                        this.recognizeCurrentFrame();

                        // Set timing recognition
                        this.recognitionInterval = setInterval(() => {
                            if (this.isRunning) {
                                this.recognizeCurrentFrame();
                            }
                        }, this.intervalTime);
                    }
                }, 1000); // 1Start recognition for the first time in seconds
            }

            restartRecognitionLoop() {
                if (this.recognitionInterval) {
                    clearInterval(this.recognitionInterval);
                    this.recognitionInterval = null;
                }

                if (this.isRunning) {
                    this.recognitionInterval = setInterval(() => {
                        if (this.isRunning) {
                            this.recognizeCurrentFrame();
                        }
                    }, this.intervalTime);
                }
            }

            async enumerateDevices() {
                try {
                    console.log('Detect camera equipment...');

                    // Check basic media device support
                    if (!navigator.mediaDevices) {
                        console.error('Browser does not support MediaDevices API');
                        this.showSecurityWarning();
                        this.addFallbackOptions();
                        return;
                    }

                    if (!navigator.mediaDevices.getUserMedia) {
                        console.error('Browser does not support getUserMedia');
                        this.showSecurityWarning();
                        this.addFallbackOptions();
                        return;
                    }

                    // Check security context
                    const isSecureContext = window.isSecureContext ||
                        location.protocol === 'https:' ||
                        location.hostname === 'localhost' ||
                        location.hostname === '127.0.0.1';

                    console.log(`Security context check:`);
                    console.log(`- protocol: ${location.protocol}`);
                    console.log(`- Host: ${location.hostname}`);
                    console.log(`- port: ${location.port}`);
                    console.log(`- isSecureContext: ${window.isSecureContext}`);
                    console.log(`- Comprehensive judgment: ${isSecureContext}`);

                    if (!isSecureContext) {
                        console.error('non-security contextÔºåCamera access will be blocked');
                        this.showSecurityWarning();
                        this.addFallbackOptions();
                        return;
                    }

                    // Enumerate devices directlyÔºàWithout requesting permission firstÔºâ
                    console.log('Try enumerating the device directly...');
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');

                    console.log(`First enumeration found ${videoDevices.length} video device`);
                    videoDevices.forEach((device, index) => {
                        console.log(`equipment ${index}: ${device.label || '[no label]'} (ID: ${device.deviceId.substring(0, 20)}...)`);
                    });

                    // If there is no device labelÔºåEnumerate again after trying to get permissions
                    let finalVideoDevices = videoDevices;
                    const hasLabels = videoDevices.some(device => device.label && device.label.trim() !== '');

                    if (!hasLabels && videoDevices.length > 0) {
                        console.log('Device has no labelÔºåTry to get permission to get device name...');
                        try {
                            const tempStream = await navigator.mediaDevices.getUserMedia({
                                video: {
                                    width: { ideal: 640 },
                                    height: { ideal: 480 }
                                }
                            });
                            console.log('Get temporary video streamÔºåStop and re-enumerate...');
                            tempStream.getTracks().forEach(track => {
                                console.log(`stop track: ${track.kind}, Label: ${track.label}`);
                                track.stop();
                            });

                            // Re-enumeration to get device name
                            const devicesWithLabels = await navigator.mediaDevices.enumerateDevices();
                            finalVideoDevices = devicesWithLabels.filter(device => device.kind === 'videoinput');

                            console.log(`Found after obtaining permission ${finalVideoDevices.length} video device`);
                            finalVideoDevices.forEach((device, index) => {
                                console.log(`equipment ${index}: ${device.label || '[Still no label]'} (ID: ${device.deviceId.substring(0, 20)}...)`);
                            });
                        } catch (permissionError) {
                            console.warn('Unable to obtain camera permissions:', permissionError.name, permissionError.message);
                        }
                    }

                    if (!this.cameraSelect) {
                        console.warn('Camera selection element not found');
                        return;
                    }

                    // Clear existing options
                    this.cameraSelect.innerHTML = '';

                    if (finalVideoDevices.length === 0) {
                        console.log('Video device not detectedÔºåUse fallback options');
                        this.addFallbackOptions();
                    } else {
                        // Add camera options
                        finalVideoDevices.forEach((device, index) => {
                            const option = document.createElement('option');
                            option.value = device.deviceId;

                            // Generate friendly device names
                            let deviceName = device.label || '';
                            if (!deviceName.trim()) {
                                deviceName = `Camera Device ${index}`;
                            }

                            // Mark special device types
                            if (deviceName.toLowerCase().includes('ir') || deviceName.toLowerCase().includes('infrared')) {
                                deviceName += ` (Infrared camera)`;
                            } else if (deviceName.toLowerCase().includes('integrated')) {
                                deviceName += ` (Integrated camera)`;
                            }

                            // Add device index
                            deviceName += ` - equipment ${index}`;

                            // Specially marked recommended equipmentÔºàequipment 2Ôºâ
                            if (index === 2) {
                                deviceName += ` ‚òÖ recommend`;
                            }

                            option.textContent = deviceName;
                            this.cameraSelect.appendChild(option);
                        });

                        // Smart selection of the best equipmentÔºàPreferenceIntegrated CameraÔºâ
                        let bestDeviceIndex = 0; // The first device is selected by default

                        // Find the best deviceÔºàNon-infrared cameraÔºâ
                        finalVideoDevices.forEach((device, index) => {
                            const label = (device.label || '').toLowerCase();
                            // PreferenceIntegrated CameraÔºåavoidIRCamera
                            if (label.includes('integrated') && !label.includes('ir') && !label.includes('infrared')) {
                                bestDeviceIndex = index;
                                console.log(`Find the integrated camera: ${device.label}`);
                            }
                        });

                        if (finalVideoDevices.length > 0) {
                            this.cameraSelect.selectedIndex = bestDeviceIndex;
                            console.log(`Select device ${bestDeviceIndex}: ${this.cameraSelect.options[bestDeviceIndex].textContent}`);
                        }
                    }

                } catch (error) {
                    console.error('Device enumeration failed:', error.name, error.message, error);

                    // If it is a security context issueÔºåShow special warning
                    if (error.name === 'NotAllowedError' || error.message.includes('secure')) {
                        this.showSecurityWarning();
                    }

                    this.addFallbackOptions();
                }
            }

            addFallbackOptions() {
                if (!this.cameraSelect) return;

                console.log('Use the backup camera option');
                this.cameraSelect.innerHTML = '';

                // Check security context
                const isSecureContext = window.isSecureContext ||
                    location.protocol === 'https:' ||
                    location.hostname === 'localhost' ||
                    location.hostname === '127.0.0.1';

                if (!isSecureContext) {
                    // if not security contextÔºåShow warning options
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '‚ö†Ô∏è needHTTPSorlocalhostto access the camera';
                    option.disabled = true;
                    this.cameraSelect.appendChild(option);

                    const helpOption = document.createElement('option');
                    helpOption.value = 'help';
                    helpOption.textContent = 'Click to view solutions';
                    this.cameraSelect.appendChild(helpOption);

                    this.cameraSelect.selectedIndex = 0;
                    return;
                }

                // Add standard camera options
                const deviceOptions = [
                    { value: '', label: 'Default camera' },
                    { value: 'device1', label: 'camera equipment 1' },
                    { value: 'device2', label: 'camera equipment 2' },
                    { value: 'device3', label: 'camera equipment 3' }
                ];

                deviceOptions.forEach((deviceOpt, index) => {
                    const option = document.createElement('option');
                    option.value = deviceOpt.value;
                    option.textContent = deviceOpt.label;
                    this.cameraSelect.appendChild(option);
                });

                // The first device is selected by default
                this.cameraSelect.selectedIndex = 0;
                console.log('Device selected by default 0');
            }

            captureFrame() {
                if (!this.video || !this.canvas || !this.ctx) {
                    return null;
                }

                try {
                    // set upcanvassize
                    this.canvas.width = this.video.videoWidth;
                    this.canvas.height = this.video.videoHeight;

                    // draw current frame
                    this.ctx.drawImage(this.video, 0, 0);

                    // Convert toblob
                    return new Promise((resolve) => {
                        this.canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    });

                } catch (error) {
                    console.error('Failed to capture frame:', error);
                    return null;
                }
            }

            async recognizeCurrentFrame() {
                try {
                    // Check if region is selected
                    const regionSelect = document.getElementById('recognitionRegion');
                    if (!regionSelect || !regionSelect.value) {
                        if (this.webcamStatus) {
                            this.webcamStatus.className = 'webcam-status';
                            this.webcamStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Please select region';
                        }
                        return;
                    }

                    // update status
                    if (this.webcamStatus) {
                        this.webcamStatus.className = 'webcam-status recording';
                        this.webcamStatus.innerHTML = '<i class="bi bi-record-circle me-1"></i>Recognizing...';
                    }

                    // Capture current frame
                    const frameBlob = await this.captureFrame();
                    if (!frameBlob) {
                        throw new Error('Unable to capture video frames');
                    }

                    // Send to identification interface with region
                    const formData = new FormData();
                    formData.append('file', frameBlob, `frame_${Date.now()}.jpg`);
                    formData.append('region', regionSelect.value);

                    const response = await fetch('/api/recognize', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Identify interface errors: ${response.status}`);
                    }

                    const result = await response.json();

                    // Process recognition results with confirmation logic
                    this.handleRecognitionResult(result);

                } catch (error) {
                    console.error('Identify errors in real time:', error);

                    // Update error status
                    if (this.webcamStatus) {
                        this.webcamStatus.className = 'webcam-status';
                        this.webcamStatus.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Recognition error';
                    }

                } finally {
                    // return to normal state
                    setTimeout(() => {
                        if (this.webcamStatus && this.isRunning) {
                            this.webcamStatus.className = 'webcam-status active';
                            this.webcamStatus.innerHTML = '<i class="bi bi-camera-video-fill me-1"></i>Camera is running';
                        }
                    }, 500);
                }
            }

            handleRecognitionResult(result) {
                if (!result || !result.success) {
                    console.log('Face not recognized or recognition failed');
                    this.clearVideoOverlays();
                    return;
                }

                // APIWhat is returned is matches no faces
                const matches = result.matches || [];
                if (matches.length === 0) {
                    console.log('No faces detected or no matches');
                    this.clearVideoOverlays();
                    return;
                }

                console.log('Live recognition result:', result);
                console.log('Total matches received:', matches.length);

                // Clear previous overlay
                this.clearVideoOverlays();

                // Process each recognized face - useAPIThe correct structure returned
                matches.forEach((match, index) => {
                    console.log(`Match ${index + 1}:`, {
                        name: match.name,
                        match_score: match.match_score,
                        person_id: match.person_id,
                        bbox: match.bbox
                    });

                    // Shows an overlay of all detected facesÔºàIncludes known and unknownÔºâ
                    if (match.bbox) {
                        this.addFaceOverlay(match);
                    }

                    // Only process identified people (non-unknown) with 2-check confirmation
                    if (match.person_id && match.person_id !== -1 && match.name && match.name !== 'Unknown') {
                        const personKey = `${match.person_id}_${match.name}`;
                        
                        // Initialize confirmation counter
                        if (!this.matchConfirmations[personKey]) {
                            this.matchConfirmations[personKey] = {
                                count: 0,
                                match: match
                            };
                        }
                        
                        // Increment confirmation count
                        this.matchConfirmations[personKey].count++;
                        console.log(`Confirmation ${this.matchConfirmations[personKey].count}/${this.confirmationThreshold} for ${match.name}`);
                        
                        // Check if we have enough confirmations
                        if (this.matchConfirmations[personKey].count >= this.confirmationThreshold) {
                            console.log(`‚úì Confirmed match: ${match.name} (${match.match_score.toFixed(1)}%)`);
                            
                            // Add to results
                            this.addRecognitionResult({
                                name: match.name,
                                person_id: match.person_id,
                                face_encoding_id: match.face_encoding_id,
                                confidence: match.match_score / 100,
                                timestamp: new Date().toLocaleTimeString(),
                                bbox: match.bbox
                            });
                            
                            // Stop recognition after confirmed match
                            this.stopWebcam();
                            
                            // Show success message
                            if (window.ToastManager) {
                                ToastManager.show(`Face recognized: ${match.name}`, 'success');
                            }
                            
                            // Reset confirmations
                            this.matchConfirmations = {};
                        }
                    } else {
                        console.log(`Live recognition: Unknown face detected`);
                    }
                });

                // Update result count
                this.updateResultsCount();
            }

            addRecognitionResult(person) {
                // Add to history
                this.recognitionHistory.unshift({
                    ...person,
                    id: Date.now()
                });

                // Keep history no longer than50strip
                if (this.recognitionHistory.length > 50) {
                    this.recognitionHistory = this.recognitionHistory.slice(0, 50);
                }

                // Update interface
                this.updateLiveResults(person);

                console.log(`recognized: ${person.name} (Confidence: ${(person.confidence * 100).toFixed(1)}%)`);
            }

            async updateLiveResults(person) {
                if (!this.liveResults) return;

                // Fetch person details to get emp_id
                let empId = 'N/A';
                let empRank = '';
                try {
                    const personResponse = await fetch(`/api/person/${person.person_id}`);
                    if (personResponse.ok) {
                        const personData = await personResponse.json();
                        empId = personData.emp_id || 'N/A';
                        empRank = personData.emp_rank || '';
                    }
                } catch (error) {
                    console.error('Failed to fetch person details:', error);
                }

                // Fetch registered image if face_encoding_id is available
                let imageUrl = null;
                if (person.face_encoding_id) {
                    try {
                        const response = await fetch(`/api/face/${person.face_encoding_id}/image`);
                        if (response.ok) {
                            const blob = await response.blob();
                            imageUrl = URL.createObjectURL(blob);
                        }
                    } catch (error) {
                        console.error('Failed to fetch registered image:', error);
                    }
                }

                // Create results card with Submit/Cancel buttons
                const resultCard = document.createElement('div');
                resultCard.className = 'detected-person';
                resultCard.id = `person-result-${person.person_id}`;
                resultCard.innerHTML = `
                    ${imageUrl ? `
                        <img src="${imageUrl}" alt="${person.name}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px;">
                    ` : `
                        <div class="person-avatar">
                            ${person.name.charAt(0).toUpperCase()}
                        </div>
                    `}
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-1">${person.name}</h6>
                            <small class="text-muted">${person.timestamp}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Emp ID: ${empId}</small>
                            <span class="badge bg-success">‚úì Recognized</span>
                        </div>
                        ${empRank ? `
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <small class="text-muted">Rank: ${empRank}</small>
                        </div>
                        ` : ''}
                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-success btn-sm flex-fill" onclick="markAttendance(${person.person_id}, '${person.name}')">
                                <i class="bi bi-check-circle me-1"></i>Submit Attendance
                            </button>
                            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="cancelRecognition()">
                                <i class="bi bi-x-circle me-1"></i>Cancel
                            </button>
                        </div>
                    </div>
                `;

                // Clear empty status
                const emptyState = this.liveResults.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                // add to top
                this.liveResults.insertBefore(resultCard, this.liveResults.firstChild);

                // keep the most10results
                const results = this.liveResults.querySelectorAll('.detected-person');
                if (results.length > 10) {
                    results[results.length - 1].remove();
                }
            }

            updateHistoryPanel() {
                const historyPanel = document.getElementById('recognitionHistory');
                const historyList = document.getElementById('historyList');

                if (!historyPanel || !historyList) return;

                if (this.recognitionHistory.length > 0) {
                    historyPanel.style.display = 'block';

                    historyList.innerHTML = this.recognitionHistory.slice(0, 20).map(person => `
                        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                            <div>
                                <strong>${person.name}</strong>
                                <small class="text-muted d-block">Confidence: ${(person.confidence * 100).toFixed(1)}%</small>
                            </div>
                            <small class="text-muted">${person.timestamp}</small>
                        </div>
                    `).join('');
                }
            }

            updateResultsCount() {
                this.resultsCount = this.recognitionHistory.length;
                if (this.resultsCounter) {
                    this.resultsCounter.textContent = this.resultsCount;
                }
            }

            updateResultsPanel(message, type = 'info') {
                if (!this.liveResults) return;

                if (type === 'warning') {
                    // For warning typeÔºåinsert directlyHTMLcontent
                    this.liveResults.innerHTML = message;
                    return;
                }

                let iconClass = 'bi bi-camera-video';
                let textClass = 'text-muted';

                if (type === 'error') {
                    iconClass = 'bi bi-exclamation-triangle';
                    textClass = 'text-danger';
                } else if (type === 'success') {
                    iconClass = 'bi bi-check-circle';
                    textClass = 'text-success';
                }

                this.liveResults.innerHTML = `
                    <div class="empty-state ${textClass}">
                        <i class="${iconClass}"></i>
                        <h6>${message}</h6>
                    </div>
                `;
            }

            // Show security context warning
            showSecurityWarning() {
                const message = `
                    <div class="alert alert-warning" role="alert">
                        <h5 class="alert-heading"><i class="bi bi-shield-exclamation me-2"></i>Camera access restricted</h5>
                        <p class="mb-2">due to security restrictionsÔºåBrowser does not allow camera access in non-secure context„ÄÇ</p>
                        <hr>
                        <div class="mb-2">
                            <strong>solutionÔºö</strong>
                            <ul class="mb-0">
                                <li>use <code>https://</code> visit this page</li>
                                <li>Or use <code>localhost</code> accessÔºàlikeÔºö<code>http://localhost:8000</code>Ôºâ</li>
                                <li>Or use <code>127.0.0.1</code> accessÔºàlikeÔºö<code>http://127.0.0.1:8000</code>Ôºâ</li>
                            </ul>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                            <button class="btn btn-primary btn-sm" onclick="window.location.href='http://localhost:8000'">
                                <i class="bi bi-arrow-right me-1"></i>use localhost access
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="showMoreHelp()">
                                <i class="bi bi-question-circle me-1"></i>more help
                            </button>
                        </div>
                    </div>
                `;

                this.updateResultsPanel(message, 'warning');
            }

            // Video overlay method
            clearVideoOverlays() {
                const videoOverlay = document.getElementById('videoOverlay');
                if (videoOverlay) {
                    videoOverlay.innerHTML = '';
                }
            }

            addFaceOverlay(match) {
                const videoOverlay = document.getElementById('videoOverlay');
                if (!videoOverlay || !match.bbox || !this.video) {
                    return;
                }

                // Get video size
                const videoRect = this.video.getBoundingClientRect();
                const videoWidth = this.video.videoWidth;
                const videoHeight = this.video.videoHeight;

                // If the video size is0Ôºåskip overlay
                if (videoWidth === 0 || videoHeight === 0) {
                    return;
                }

                // Calculate scaling
                const scaleX = videoRect.width / videoWidth;
                const scaleY = videoRect.height / videoHeight;

                // bboxFormat: [x1, y1, x2, y2]
                const [x1, y1, x2, y2] = match.bbox;
                const width = x2 - x1;
                const height = y2 - y1;

                // Calculate position on display video
                const overlayLeft = x1 * scaleX;
                const overlayTop = y1 * scaleY;
                const overlayWidth = width * scaleX;
                const overlayHeight = height * scaleY;

                // Create an overlay element
                const overlay = document.createElement('div');
                overlay.className = `face-overlay ${match.person_id !== -1 && match.name !== 'Unknown' ? 'known' : 'unknown'}`;
                overlay.style.left = `${overlayLeft}px`;
                overlay.style.top = `${overlayTop}px`;
                overlay.style.width = `${overlayWidth}px`;
                overlay.style.height = `${overlayHeight}px`;

                // Add name tag
                const label = document.createElement('div');
                label.className = 'face-label';

                if (match.person_id !== -1 && match.name !== 'Unknown') {
                    label.textContent = `${match.name} (ID: ${match.person_id})`;
                } else {
                    label.textContent = 'Unknown';
                }

                overlay.appendChild(label);

                // Add confidence label
                const confidence = document.createElement('div');
                confidence.className = 'face-confidence';
                confidence.textContent = `${match.match_score.toFixed(1)}%`;
                overlay.appendChild(confidence);

                // Add to overlay container
                videoOverlay.appendChild(overlay);

                // logging
                console.log(`Added face overlay: ${match.name} at [${x1}, ${y1}, ${x2}, ${y2}] scaled to [${overlayLeft.toFixed(1)}, ${overlayTop.toFixed(1)}, ${overlayWidth.toFixed(1)}, ${overlayHeight.toFixed(1)}]`);

                // 1Fade out overlay after seconds
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.style.opacity = '0.7';
                        // Again2Completely removed in seconds
                        setTimeout(() => {
                            if (overlay.parentNode) {
                                overlay.remove();
                            }
                        }, 2000);
                    }
                }, 1000);
            }

            // public method
            clearHistory() {
                this.recognitionHistory = [];
                this.resultsCount = 0;
                this.updateResultsCount();
                this.updateHistoryPanel();

                const historyPanel = document.getElementById('recognitionHistory');
                if (historyPanel) {
                    historyPanel.style.display = 'none';
                }

                if (window.ToastManager) {
                    ToastManager.show('Recognition history cleared', 'success');
                }
            }
        }

        // Global camera instance
        let webcamRecognition = null;

        // existDOMInitialize the camera after loading is complete
        document.addEventListener('DOMContentLoaded', function () {
            // Wait for the main application to be initialized before initializing the camera.
            setTimeout(() => {
                try {
                    webcamRecognition = new WebcamRecognition();
                    console.log('ÊëÑÂÉèÂ§¥ËØÜÂà´Á≥ªÁªüÂàùÂßãÂåñÊàêÂäü');
                } catch (error) {
                    console.error('Camera recognition system initialization failed:', error);
                }
            }, 1000);
        });

        // Update global function
        function clearRecognitionHistory() {
            if (webcamRecognition) {
                webcamRecognition.clearHistory();
            }
        }

        // Attendance functions
        async function markAttendance(personId, personName) {
            try {
                const formData = new FormData();
                formData.append('person_id', personId);
                formData.append('status', 'present');
                
                const response = await fetch('/api/attendance/mark', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Debug logging
                console.log('Attendance API Response:', result);
                console.log('already_marked flag:', result.already_marked);
                
                if (result.success) {
                    const resultCard = document.getElementById(`person-result-${personId}`);
                    if (resultCard) {
                        const buttonsDiv = resultCard.querySelector('.d-flex.gap-2');
                        if (buttonsDiv) {
                            if (result.already_marked === true) {
                                // Attendance already marked
                                buttonsDiv.innerHTML = `
                                    <div class="alert alert-info mb-0 w-100 py-2">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        <strong>Attendance Already Marked</strong><br>
                                        <small>Marked at: ${new Date(result.attendance.marked_at).toLocaleString()}</small>
                                    </div>
                                `;
                                if (window.ToastManager) {
                                    ToastManager.show(`Attendance already marked for ${personName}`, 'info');
                                }
                            } else {
                                // Successfully marked new attendance
                                buttonsDiv.innerHTML = `
                                    <div class="alert alert-success mb-0 w-100 py-2">
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                        <strong>Attendance Marked Successfully</strong><br>
                                        <small>Marked at: ${new Date(result.attendance.marked_at).toLocaleString()}</small>
                                    </div>
                                `;
                                if (window.ToastManager) {
                                    ToastManager.show(`Attendance marked for ${personName}`, 'success');
                                }
                            }
                        }
                    }
                } else {
                    throw new Error(result.error || result.message || 'Failed to mark attendance');
                }
            } catch (error) {
                console.error('Error marking attendance:', error);
                if (window.ToastManager) {
                    ToastManager.show(`Failed to mark attendance: ${error.message}`, 'error');
                }
            }
        }

        function cancelRecognition() {
            const liveResults = document.getElementById('liveRecognitionResults');
            if (liveResults) {
                liveResults.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-camera-video"></i>
                        <h6>Recognition Cancelled</h6>
                        <p class="mb-0">Click Retry to recognize again</p>
                    </div>
                `;
            }
            
            if (window.ToastManager) {
                ToastManager.show('Recognition cancelled', 'info');
            }
        }

        // Load attendance records
        async function loadAttendance() {
            try {
                const dateInput = document.getElementById('attendanceDate');
                const regionSelect = document.getElementById('attendanceRegion');
                const tableBody = document.getElementById('attendanceTableBody');
                const summary = document.getElementById('attendanceSummary');
                
                const date = dateInput.value;
                const region = regionSelect.value;
                
                if (!date) {
                    if (window.ToastManager) {
                        ToastManager.show('Please select a date', 'warning');
                    }
                    return;
                }
                
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>Loading...</td></tr>';
                
                const url = `/api/attendance?date=${date}${region ? '&region=' + region : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalEmployees').textContent = data.total;
                    document.getElementById('presentCount').textContent = data.present;
                    document.getElementById('absentCount').textContent = data.absent;
                    summary.style.display = 'flex';
                    
                    if (data.records && data.records.length > 0) {
                        tableBody.innerHTML = '';
                        
                        for (const record of data.records) {
                            let imageHtml = `<div class="person-avatar" style="width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: #007bff; color: white; font-weight: bold;">${record.name.charAt(0).toUpperCase()}</div>`;
                            
                            try {
                                const facesResponse = await fetch(`/api/person/${record.person_id}/faces`);
                                if (facesResponse.ok) {
                                    const facesData = await facesResponse.json();
                                    if (facesData.face_encodings && facesData.face_encodings.length > 0) {
                                        const faceId = facesData.face_encodings[0].id;
                                        imageHtml = `<img src="/api/face/${faceId}/image" alt="${record.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`;
                                    }
                                }
                            } catch (e) {
                                console.warn('Failed to load image for', record.name);
                            }
                            
                            const statusBadge = record.status === 'present' 
                                ? '<span class="badge bg-success">Present</span>' 
                                : '<span class="badge bg-danger">Absent</span>';
                            
                            const markedAt = record.marked_at 
                                ? new Date(record.marked_at).toLocaleTimeString() 
                                : '-';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${imageHtml}</td>
                                <td>${record.name}</td>
                                <td>${record.emp_id}</td>
                                <td>${record.emp_rank}</td>
                                <td>${statusBadge}</td>
                                <td>${markedAt}</td>
                            `;
                            tableBody.appendChild(row);
                        }
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No records found</td></tr>';
                    }
                    
                    if (window.ToastManager) {
                        ToastManager.show('Attendance loaded successfully', 'success');
                    }
                } else {
                    throw new Error(data.message || 'Failed to load attendance');
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                const tableBody = document.getElementById('attendanceTableBody');
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
                
                if (window.ToastManager) {
                    ToastManager.show(`Failed to load attendance: ${error.message}`, 'error');
                }
            }
        }

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('attendanceDate');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        });

        // Show more help information
        function showMoreHelp() {
            const helpContent = `
                <div class="modal fade" id="helpModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Camera access solutions</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle me-2"></i>Why does this problem occur?Ôºü</h6>
                                    <p>Modern browsers for security reasonsÔºåOnly allowed in security contextÔºàHTTPSorlocalhostÔºâAccess the camera in„ÄÇ</p>
                                </div>
                                
                                <h6>solutionÔºö</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-success text-white">
                                                <i class="bi bi-check-circle me-2"></i>Recommended plan
                                            </div>
                                            <div class="card-body">
                                                <h6>use localhost access</h6>
                                                <p class="small">in the address bar <code>0.0.0.0:8000</code> Change to <code>localhost:8000</code></p>
                                                <button class="btn btn-success btn-sm" onclick="window.location.href='http://localhost:8000'">
                                                    <i class="bi bi-arrow-right me-1"></i>Á´ãÂç≥Ë∑≥ËΩ¨
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-primary text-white">
                                                <i class="bi bi-shield-check me-2"></i>best solution
                                            </div>
                                            <div class="card-body">
                                                <h6>use HTTPS</h6>
                                                <p class="small">ConfigurationSSLCertificateÔºåuse <code>https://</code> access</p>
                                                <small class="text-muted">Requires server support</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Things to note</h6>
                                    <ul class="mb-0 small">
                                        <li>Make sure the camera is not in use by another application</li>
                                        <li>Check browser permission settings</li>
                                        <li>Some browsers may require manual authorization of camera access</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">closure</button>
                                <button type="button" class="btn btn-primary" onclick="window.location.href='http://localhost:8000'">
                                    <i class="bi bi-arrow-right me-1"></i>use localhost access
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insert modal boxHTML
            document.body.insertAdjacentHTML('beforeend', helpContent);

            // Show modal box
            if (window.bootstrap) {
                const modal = new bootstrap.Modal(document.getElementById('helpModal'));
                modal.show();

                // Delete modal box after hiding itDOM
                document.getElementById('helpModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            } else {
                alert('Please use http://localhost:8000 Visit this page to enable camera functionality');
            }
        }
    </script>
</body>

</html>